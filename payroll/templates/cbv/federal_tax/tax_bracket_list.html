{% load i18n %}
{% if not filing_status.use_py %}
    {% include "generic/horilla_list_table.html" %}
{% else %}
    <div class="hidden">
        <button type="submit" class="oh-btn oh-btn--secondary" id="oc-editor-button{{ filing_status.pk }}">
            {% trans "Save" %}
        </button>
    </div>
    <iframe frameBorder="0" height="450px" id="oc-editor{{ filing_status.pk }}"
            src="https://onecompiler.com/embed/python?codeChangeEvent=true&hideNew=true&hideNewFileOption=true&hideStdin=true&hideTitle=true&listenToEvents=true&availableLanguages=false&theme=dark"
            width="100%">
    </iframe>
    <script>
        var iFrame = document.getElementById('oc-editor{{ filing_status.pk }}');
        var saveDiv = document.querySelector('#oc-editor-button{{ filing_status.pk }}').parentElement;
        var saveBtn = document.getElementById('oc-editor-button{{ filing_status.pk }}');

        var initialCode = `{{ filing_status.python_code|escapejs }}`;
        var latestCode = initialCode;

        iFrame.onload = function () {
            setTimeout(function () {
                iFrame.contentWindow.postMessage({
                    eventType: 'populateCode',
                    language: 'python',
                    files: [
                        {
                            "name": "federal_tax.py",
                            "content": initialCode
                        }
                    ]
                }, "*");

                // Trigger run after injecting code
                setTimeout(function () {
                    iFrame.contentWindow.postMessage({
                        eventType: 'triggerRun'
                    }, "*");
                }, 500);
            }, 500);
        };

        window.onmessage = function (e) {
            if (e.data && e.data.language) {
                var code = e.data.files[0].content;

                if (code !== latestCode) {
                    latestCode = code;
                    if (latestCode !== initialCode) {
                        saveDiv.classList.remove("d-none");
                    }
                }
            }
        };

        saveBtn.addEventListener("click", function () {
            $.ajax({
                type: "post",
                url: "{% url 'update-py-code' filing_status.pk %}",
                data: {
                    csrfmiddlewaretoken: getCookie("csrftoken"),
                    code: latestCode,
                },
                success: function () {
                    initialCode = latestCode;
                    $('#reloadMessagesButton').click();
                    saveDiv.classList.add("hidden");
                }
            });
        });
    </script>
{% endif %}
