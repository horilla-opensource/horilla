{% load i18n %}
{% if messages %}
    <div class="oh-wrapper">
        {% for message in messages %}
            <div class="oh-alert-container">
                <div class="oh-alert oh-alert--animated {{message.tags}}">
                    {{ message }}
                </div>
            </div>
        {% endfor %}
        <script>
            setTimeout(function () {
                $(".oh-modal__close").click();
            }, 1000);
        </script>
    </div>
{% endif %}
<div class="oh-modal__dialog-header pb-0">
    <h2 class="oh-modal__dialog-title" id="objectUpdateModalLabel">
        {% trans "Multiple Approval Condition" %}
    </h2>
    <button class="oh-modal__close" aria-label="Close"
        {% if messages %}
            hx-get="{% url 'hx-multiple-approval-condition' %}" hx-target="#multipleApproveCondition"
        {% endif %}>
        <ion-icon name="close-outline"></ion-icon>
    </button>
</div>
<div class="oh-modal__dialog-body">
    <form hx-post="{% url 'multiple-level-approval-create' %}" hx-target="#objectCreateModalTarget"
        class="oh-profile-section pt-0">
        <div class="row">
            <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                <div class="oh-input__group">
                    <label class="oh-input__label" for="{{form.condition_type.id_for_label}}">
                        {% trans "Condition" %}
                    </label>
                    {{ form.condition_type }} {{ form.condition_type.errors }}
                </div>
            </div>
            <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                <div class="oh-input__group">
                    <label class="oh-input__label" for="{{form.department.id_for_label}}">
                        {% trans "Department" %}
                    </label>
                    {{ form.department }} {{ form.department.errors }}
                    <div class="mt-2">
                        {{ form.all_departments }} {{ form.all_departments.label_tag }}
                    </div>
                </div>
            </div>
        </div>
        {% if not form.condition_field.is_hidden or not form.condition_operator.is_hidden %}
        <div class="row leave-field">
            {% if not form.condition_field.is_hidden %}
            <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                <div class="oh-input__group">
                    <label class="oh-input__label" for="{{form.condition_field.id_for_label}}">
                        {% trans "Condition Field" %}
                    </label>
                    {{ form.condition_field }} {{ form.condition_field.errors }}
                </div>
            </div>
            {% endif %}
            {% if not form.condition_operator.is_hidden %}
            <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                <div class="oh-input__group">
                    <label class="oh-input__label" for="{{ form.condition_operator.id_for_label }}">
                        {% trans "Condition Operator" %}
                    </label>
                    {{ form.condition_operator }} {{ form.condition_operator.errors }}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% if not form.condition_value.is_hidden %}
        <div class="row leave-field">
            <div class="col-12 col-sm-12 col-md-6 col-lg-6" id="conditionValueDiv">
                <div class="oh-input__group">
                    <label class="oh-input__label" for="{{ form.condition_value.id_for_label }}">
                        {% trans "Condition Value" %}
                    </label>
                    {{ form.condition_value }} {{ form.condition_value.errors }}
                </div>
            </div>
        </div>
        {% endif %}
        <div class="row">
            <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                <div class="oh-input__group">
                    <label class="oh-input__label" for="{{ form.company_id.id_for_label }}">
                        {% trans "Company" %}
                    </label>
                    {{ form.company_id }} {{ form.company_id.errors }}
                </div>
            </div>
        </div>
        <div class="oh-input__group">
            <label class="oh-input__label" for="{{ form.multi_approval_manager.id_for_label }}">
                {% trans "Approval Managers" %}
            </label>
            {{ form.multi_approval_manager }} {{ form.multi_approval_manager.errors }}
        </div>
        <div id="multiApprovalManager_0" class="pt-2" style="text-align: end">
            <a hx-target="#multiApprovalManager_0" hx-swap="outerHTML" hx-get="{% url 'add-more-approval-managers' %}"
                role="button" style="color: green">{% trans "Add more managers.." %}</a>
        </div>
        <div class="oh-modal__dialog-footer pb-0" style="padding: 1rem 0.2rem 1rem">
            <button type="submit" class="oh-btn oh-btn--secondary">
                {% trans "Apply" %}
            </button>
        </div>
    </form>
</div>


<script>
(function () {
  function initMultipleApprovalUI(root = document) {
    // --- condition fields toggle ---
    const typeSelect = root.getElementById('id_condition_type') || root.querySelector("select[name='condition_type']");
    const leaveFields = root.querySelectorAll('.leave-field');

    function toggleConditionFields() {
      if (!typeSelect) return;
      const hide = typeSelect.value === 'medical_reimbursement';
      leaveFields.forEach(el => el.style.display = hide ? 'none' : '');
    }
    if (typeSelect) {
      toggleConditionFields();
      typeSelect.addEventListener('change', toggleConditionFields);
    }

    // --- all departments toggle ---
    const allDepartmentsCheckbox = root.querySelector("input[name='all_departments']") || root.getElementById('id_all_departments');
    const departmentSelect = root.querySelector("select[name='department']") || root.getElementById('id_department');

    function clearSelect(select) {
      if (!select) return;
      if (select.multiple) {
        Array.from(select.options).forEach(opt => opt.selected = false);
      } else {
        select.value = "";
      }
      // If using Select2/Choices/etc., sync plugin:
      if (window.jQuery && window.jQuery(select).trigger) {
        try { window.jQuery(select).trigger('change'); } catch (e) {}
      }
    }

    function toggleDepartmentSelect() {
      if (!departmentSelect) return;
      if (allDepartmentsCheckbox && allDepartmentsCheckbox.checked) {
        departmentSelect.disabled = true;   // disable only
        clearSelect(departmentSelect);      // clear values so nothing submits
      } else {
        departmentSelect.disabled = false;  // enable again
      }
    }

    if (allDepartmentsCheckbox) {
      toggleDepartmentSelect();
      allDepartmentsCheckbox.addEventListener('change', toggleDepartmentSelect);
    }
  }

  // run on initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function () { initMultipleApprovalUI(); });
  } else {
    initMultipleApprovalUI();
  }

  // re-init when HTMX swaps content
  document.body.addEventListener('htmx:afterSwap', function (evt) {
    initMultipleApprovalUI(evt.detail && evt.detail.target ? evt.detail.target : document);
  });
})();
</script>
