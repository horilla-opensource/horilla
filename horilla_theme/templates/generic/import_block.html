{% load generic_template_filters i18n %}
{% if import_fields and import_accessibility %}
  <button id="import_{{ view_id }}" class="px-4 py-2 bg-[#129192] text-white rounded-md text-xs hover:bg-primary-800 transition duration-300" data-toggle="oh-modal-toggle" data-target="#importModal{{ view_id }}" onclick="
      ids = $('#{{ selected_instances_key_id }}').attr('data-ids');
      $('#submitGetImportSheet{{ view_id }}Form').find('[name=selected_ids]').val(ids);
   ">
    <span class="label">{% trans 'Import' %}</span>
    (&nbsp;<i class="fa-solid fa-download pe-1"></i>)
  </button>
  <div class="oh-modal" id="importModal{{ view_id }}">
    <div class="oh-modal__dialog" id="objectCreateModalTarget">
      <div class="oh-modal__dialog-header">
        <h2 class="oh-modal__dialog-title">Import Records</h2>
        <button class="oh-modal__close" aria-label="Close"><ion-icon name="close-outline" role="img"></ion-icon></button>
        <div class="oh-modal__dialog-body p-0 pb-4">
          <form hx-post="/{{ post_import_sheet_path }}" hx-encoding="multipart/form-data" class="oh-profile-section">
            <div class="oh-modal__dialog-body mr-5" id="uploading" style="display: none">
              <div class="loader-container">
                <div class="loader"></div>
                <div class="loader-text">Uploading...</div>
              </div>
            </div>
            <div id="error-container" style="color: red"></div>
            <div class="modal-body">
              <div class="oh-dropdown__import-form">
                <label class="oh-dropdown__import-label">
                  <ion-icon name="cloud-upload" class="oh-dropdown__import-form-icon md hydrated" role="img" aria-label="cloud upload"></ion-icon>
                  <span class="oh-dropdown__import-form-title">Upload a File</span>
                  <span class="oh-dropdown__import-form-text">Drag and drop files here</span>
                </label>
                <input type="file" name="file" required="" />
                <div class="d-inline float-end">
                  <a onclick="
                                  $('#submitGetImportSheet{{ view_id }}').click();
                                  " style="text-decoration:none; display: inline-block;" class="oh-dropdown__link" hx-on:click="template_download(event)">
                    <ion-icon name="cloud-download-outline" style="font-size:20px; vertical-align: middle;" role="img" class="md hydrated"></ion-icon>
                    <span>Download Template</span>
                  </a>
                </div>
              </div>
            </div>
            {% if import_help %}
              <h6 class="mt-3"><b>{% trans 'Import Help' %}</b></h6>
              <div class="row">
                {% for key in import_help %}
                  <div class="mt-1 col-3">
                    <b>{{ key }}</b>
                    {% for val in import_help|get_item:key %}
                      <li>{{ val }}</li>
                    {% endfor %}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
            <div class="modal-footer d-flex flex-row-reverse">
              <input type="submit" class="oh-btn oh-btn--small oh-btn--secondary w-100 mt-3" value="Upload" />
            </div>
          </form>
          <script>
            let htmxBusy = false
            
            document.body.addEventListener('htmx:configRequest', function (event) {
              if (htmxBusy) {
                event.preventDefault()
                console.warn('Blocked concurrent HTMX request.')
              } else {
                htmxBusy = true
              }
            })
            
            document.body.addEventListener('htmx:afterRequest', function () {
              htmxBusy = false
            })
            
            document.body.addEventListener('htmx:responseError', function () {
              htmxBusy = false
            })
          </script>
          <form id="submitGetImportSheet{{ view_id }}Form" action="/{{ get_import_sheet_path }}" method="post">
            {% csrf_token %}
            <input type="text" name="selected_ids" hidden />
            <input type="submit" hidden id="submitGetImportSheet{{ view_id }}" />
          </form>
        </div>
      </div>
    </div>
  </div>
{% endif %}
