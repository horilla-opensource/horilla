{% load static i18n audit_filters %}
<div id="generic-history-container">
  <button hidden hx-get="{{ request.path }}" class="reload-record" hx-target="#generic-history-container" hx-swap="outerHTML"></button>

  <div class="oh-activity-sidebar__header mt-5 sticky top-0 z-[100] bg-white pb-3">
    <a style="cursor: pointer;" onclick="$('.oh-activity-sidebar--show').removeClass('oh-activity-sidebar--show');">
      <ion-icon name="chevron-forward-outline" class="oh-activity-sidebar__header-icon me-2 oh-activity-sidebar__close md flip-rtl hydrated"></ion-icon>
    </a>
    <span class="oh-activity-sidebar__title fw-bold">{{ object }}'s Logs</span>
  </div>

  {% if tracking %}
  <div class="relative max-w-[800px] m-auto pt-8 pb-10" style="margin-right:165px;">
    <!-- Center vertical line -->
    <div class="absolute left-1/2 transform -translate-x-1/2 h-full w-1 bg-[#dbdbdb] hidden md:block"></div>

    <ul class="space-y-10">
      {% for history in tracking %}
      <li class="flex justify-between items-start relative">
        <!-- Left side: Date/Time -->
        <div class="md:w-1/2 md:pr-10 md:text-right mt-2 md:mt-0 order-1 md:order-none">
          <div class="inline-block px-4 py-2 rounded-md text-center bg-primary-200 text-primary-600">
            <span class="text-xs block font-semibold">
              <span class="dateformat_changer">{{ history.pair.1.history_date|date:'M. d, Y' }}</span>
              &nbsp,&nbsp
              <span class="timeformat_changer">{{ history.pair.1.history_date|date:'g:i A' }}</span>
            </span>
          </div>
        </div>

        <!-- Timeline dot with user avatar -->
        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 z-10 w-10 h-10 rounded-full bg-white border-2 border-primary-600 flex items-center justify-center overflow-hidden">
          <img src="{{ history.updated_by.get_avatar }}" alt="user" class="w-full h-full object-cover rounded-full" />
        </div>

        <!-- Right side: Details -->
        <div class="md:w-1/2 md:pl-10 md:text-left mt-2">
          <h5 class="text-xs font-semibold">
            {{ history.updated_by.get_full_name|default:"Horilla Bot" }}
          </h5>
          {% if history.pair.0.history_title %}
          <p class="text-xs text-[#777777] mb-2">{{ history.pair.0.history_title }}</p>
          {% endif %}
          {% if history.pair.0.history_description %}
          <p class="text-xs text-[#777777] mb-2">{{ history.pair.0.history_description }}</p>
          {% endif %}

          {% if history.pair.0.history_tags.all %}
          <div class="oh-history_tabs mb-2">
            {% for tag in history.pair.0.history_tags.all %}
            <a href="#" class="oh-history_msging-email oh-history_tabs-items">{{ tag.title }}</a>
            {% endfor %}
          </div>
          {% endif %}

          <div class="bg-white p-3 rounded-md border border-gray-200 shadow-sm">
            <h3 class="text-primary-600 font-semibold text-xs mb-2">{% trans "Changes" %}</h3>
            <ul class="space-y-1">
              {% for change in history.changes %}
              <li class="text-xs flex items-center justify-between gap-1">
                <span>{{ history.pair.1|fk_history:change }}</span>
                <img src="{% static '/images/ui/arrow-right-line.svg' %}" alt="â†’" class="w-3 h-3 inline-block" />
                <span>{{ history.pair.0|fk_history:change }}</span>
                <i class="text-gray-500 text-[10px]">({{ change.field }})</i>
              </li>
              {% endfor %}
            </ul>

            {% if has_perm_to_revert and history.pair.1.pk %}
            <div class="mt-2 text-right">
              <button hidden id="revert{{history.pair.1.pk}}" hx-post="{% url 'history-revert' object.pk history.pair.1.pk %}?model={{ model }}"></button>
              <a href="javascript:void(0);" class="text-primary-600 text-xs" title="Restore previous state"
                onclick="Swal.fire({
                    title: 'Are you sure?',
                    text: 'This will revert the object to a previous state.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, revert it'
                }).then(result => {
                    if (result.isConfirmed) {
                      document.getElementById('revert{{ history.pair.1.pk }}').click();
                    }
                })">
                <ion-icon name="git-pull-request-outline" class="text-base"></ion-icon>
                {% trans "Revert" %}
              </a>
            </div>
            {% endif %}
          </div>
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>

  {% else %}
  <div class="oh-wrapper h-full text-center my-10">
    <div class="bg-white p-6 rounded-md shadow-md inline-block">
      <img src="{% static 'images/ui/history.png' %}" alt="No history" width="250" class="mx-auto mb-4" />
      <p class="text-[#666] mb-2">{% trans "No history found." %}</p>
    </div>
  </div>
  {% endif %}
</div>
