{% load static i18n basefilters %}
<style>
	#canvasContainer {
		height: 70vh;
	}

	#objectDetailW75Modal #canvasContainer {
		height: 400px;
	}
</style>

{% if request.user.employee_get.id == emp_id or perms.project.view_timesheet or request.user|is_reportingmanager %}
<div
	class="oh-card-dashboard oh-card-dashboard--no-scale oh-card-dashboard--transparent bg-white p-3 rounded-md shadow-card"
>
	<div
		class="oh-card-dashboard__header oh-card-dashboard__header--divider d-flex justify-content-between align-items-center p-3"
	>
		<div class="d-flex justify-content-start">
			<h5 class="text-lg font-semibold">
				{% trans "Personal Timesheet of" %} {{emp_name|capfirst}}
			</h5>
		</div>
		<div style="display: flex; align-items: baseline; margin-left: auto">
			<input type="hidden" id="timesheetDate" value="{{request.GET.date}}" />
			<select
				class="oh-select oh-select--sm me-5"
				name=""
				id="personalTimesheetSelect"
			>
				<option value="week" selected>{% trans "Week" %}</option>
				<option value="month">{% trans "Month" %}</option>
			</select>
			<span class="mb-1 font-medium text-sm me-5 ms-5"
				><a id="previous">{% trans "Previous" %}</a></span
			>
			<span class="mb-1 font-medium text-sm me-5"
				><a id="next">{% trans "Next" %}</a></span
			>
		</div>
	</div>
	<div class="p-3" id="canvasContainer">
		<canvas id="personalChart"></canvas>
	</div>
</div>
{% else %}
	{% include '404.html' %}
{% endif %}

<script>
	$(document).ready(function () {
		$(document).ready(function () {
			const $modal = $("#objectDetailW75Modal");
			const $target = $("#objectDetailW75ModalTarget");

			const observer = new MutationObserver(() => {
				if (!$modal.hasClass("oh-modal--show")) {
					$target.html("");
				}
			});

			observer.observe($modal[0], {
				attributes: true,
				attributeFilter: ["class"]
			});
		});

		Date.prototype.getWeek = function () {
			return $.datepicker.iso8601Week(this);
		};

		let timesheetDateVal = $("#timesheetDate").val();

		let myDate = timesheetDateVal ? new Date(timesheetDateVal) : new Date();

	    let myWeek = myDate.getWeek();
	    let year = myDate.getFullYear();
	    let month = myDate.getMonth();
	    let personalChart = null;

	    function initChart() {
	        const ctx = document.getElementById("personalChart").getContext("2d");
	        personalChart = new Chart(ctx, {
	            type: "bar",
	            data: {
	                labels: [],
	                datasets: []
	            },
				options: {
					responsive: true,
					maintainAspectRatio: false,
					animation: {
						duration: 1000,
						easing: 'easeInOutQuart'
					},
					scales: {
						x: { stacked: true },
						y: { stacked: true }
					},
					elements: {
						bar: {
							borderRadius: 20,
						}
					}
				}
	        });
	    }

	    function updateChart(dataSet, labels) {
	        personalChart.data.labels = labels;
	        personalChart.data.datasets = dataSet;
	        personalChart.update();
	    }

	    function fetchChartData() {
	        $.ajax({
	            type: "GET",
	            url: "/project/personal-time-sheet/",
	            data: {
	                emp_id: {{emp_id}},
	                year: year,
	                week: myWeek,
	                month: month,
	                selected: $("#personalTimesheetSelect").val(),
	            },
	            success: function (response) {
	                updateChart(response.dataSet, response.labels);
	            },
	            error: function () {
	                console.error("Error fetching chart data");
	            }
	        });
	    }

	    initChart();
	    fetchChartData();

	    $("#previous").click(function () {
	        if ($("#personalTimesheetSelect").val() === "week") {
	            myWeek--;
	            if (myWeek < 1) {
	                year--;
	                myWeek += 52;
	            }
	        } else if ($("#personalTimesheetSelect").val() === "month") {
	            month--;
	            if (month < 0) {
	                year--;
	                month += 12;
	            }
	        }
	        fetchChartData();
	    });

	    $("#next").click(function () {
	        const thisWeek = myDate.getWeek();
	        const thisMonth = myDate.getMonth();

	        if ($("#personalTimesheetSelect").val() === "week") {
	            myWeek = Math.min(myWeek + 1, thisWeek);
	        } else if ($("#personalTimesheetSelect").val() === "month") {
	            month = Math.min(month + 1, thisMonth);
	        }

	        year = myDate.getFullYear();
	        fetchChartData();
	    });

	    $("#personalTimesheetSelect").change(fetchChartData);
	});
</script>
