{% load static i18n generic_template_filters %}

<div id="{{ view_id|safe }}" class="hlv-container">
        <div
            class="oh-modal"
            id="bulkUpdateModal{{view_id|safe}}"
            role="dialog"
            aria-labelledby="bulkUpdateModal{{view_id|safe}}"
            aria-hidden="true"
        >
            <div
                class="oh-modal__dialog"
                id="bulkUpdateModalBody{{view_id|safe}}"
            ></div>
        </div>
        {% include "generic/export_fields_modal.html" %}
        <script>
            if (!$(".HTV").length) {
                reloadMessage(null);
            }
        </script>
        <button
            class="reload-record"
            id="{{view_id|safe}}Reload"
            hidden
            hx-get="{{request.path}}?{{saved_filters.urlencode}}"
            hx-target="#{{view_id|safe}}"
            hx-swap="outerHTML"
            hx-on:click="htmxLoadIndicator(this);"
        ></button>
        {% if show_filter_tags %} {% include "generic/filter_tags.html" %} {% endif %}

        {% if queryset|length %}
            {% if bulk_select_option %} {% include "generic/quick_actions.html" %} {% endif %}

            <div class="bg-white p-5 pe-2 pt-3 rounded-md shadow-card relative">
                {% if show_toggle_form %}
                <div class="oh-sticky-dropdown--header absolute right-[30px] top-[25px]" style="z-index: 13;">
                    <div class="oh-dropdown" x-data="{ open: false }">
                        <button class="oh-sticky-dropdown_btn" @click="open = !open">
                        <ion-icon
                            name="ellipsis-vertical-sharp"
                            role="img"
                            class="md hydrated"
                            aria-label="ellipsis vertical sharp"
                        ></ion-icon>
                        </button>
                        <div
                        class="oh-dropdown__menu oh-sticky-table_dropdown"
                        x-show="open"
                        @click.outside="
                            open = false
                            $($el).closest('#{{ view_id|safe }}').find('.reload-record').click();
                        "
                        >
                        {{ toggle_form.as_list }}
                        </div>
                    </div>
                </div>
                {% endif %}
                <div
                    class="max-h-[calc(100vh_-_300px)] overflow-hidden overflow-y-auto overflow-x-auto"
                >
                    <table class="fixed-table w-full" data-bulk-select-option = "{{bulk_select_option|yesno:'true,false'}}">
                        <thead class="sticky top-0 bg-[white] z-[1]">
                            <tr class="border-b border-[#ececec]">
                                {% if bulk_select_option %}
                                    <th
                                        class="text-sm font-medium text-left p-3 w-30"
                                    >
                                        <input
                                            type="checkbox"
                                            value=""
                                            class="bulk-list-table-row custom-checkbox w-4 h-4 bg-[#E9EDF7] rounded-sm text-[#e54f38] cursor-pointer"
                                            title="Select All"
                                            onchange="
                                                $(this).closest('.fixed-table').find('.list-table-row').prop('checked',$(this).is(':checked')).change();
                                                $(document).ready(function () {
                                                reloadSelectedCount($('#count_{{view_id|safe}}'),'{{selected_instances_key_id}}');
                                                reloadSelectedCount($('.count_{{view_id|safe}}'),'{{selected_instances_key_id}}');
                                                });
                                            "
                                        />
                                    </th>
                                {% endif %}

                                {% for cell in columns %}
                                    {% with cell_attr=header_attrs|get_item:cell.1 %}
                                    <th
                                        class="text-sm font-medium text-left p-3"
                                        id="{{view_id}}-{{ forloop.counter }}-{{cell.1}}-header"

                                    >
                                        <div class="flex gap-3 min-w-[150px] {% for sort_map in sortby_mapping %} {% if sort_map.0 == cell.0 %}cursor-pointer {% endif %}{% endfor %}"
                                            {{cell_attr|safe}}
                                            {% for sort_map in sortby_mapping %}
                                                {% if sort_map.0 == cell.0 %}
                                                    hx-get="{{search_url}}?{{saved_filters.urlencode}}&{{sortby_key}}={{sort_map.1}}&filter_applied=on"
                                                    hx-target="#{{view_id}}"
                                                {% endif %}
                                            {% endfor %}
                                        >

                                            {% for sort_map in sortby_mapping %}
                                                {% if sort_map.0 == cell.0 %}
                                                    <span
                                                        class="text-xs flex items-center text-primary-600"
                                                    >
                                                        {% if request.sort_order == "asc" and request.sort_key == sort_map.1 %}
                                                            <i class="fa-solid fa-arrow-down"></i>
                                                        {% elif request.sort_order == "desc" and request.sort_key == sort_map.1 %}
                                                            <i class="fa-solid fa-arrow-up"></i>
                                                        {% else %}
                                                            <i class="fa-solid fa-arrow-up"></i>
                                                            <i class="fa-solid fa-arrow-down"></i>
                                                        {% endif %}
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                            <span class="flex w-max"> {{cell.0|safe}} </span>
                                        </div>
                                    </th>
                                    {% endwith %}
                                {% endfor %}
                                {% if options or option_method%}
                                    <th class="text-sm font-medium p-3" {{header_attrs.option|safe}}>
                                        {% trans "Options" %}
                                    </th>
                                {% endif %}
                                {% if actions or action_method %}
                                    <th class="stickyright text-sm font-medium p-3 flex" {{header_attrs.action|safe}}>
                                        {% trans "Actions" %}
                                    </th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for instance in queryset %}
                                <tr class="border-b border-[#f3f3f3]{% if row_attrs %} cursor-pointer {% endif %}"
                                    data-instance-id="{{instance.id}}"
                                    {{row_attrs|format:instance|safe}}
                                >
                                    {% if bulk_select_option %}
                                    <td class="text-sm text-left p-3 text-[#666]">
                                        <input
                                            type="checkbox"
                                            class="list-table-row custom-checkbox w-4 h-4 bg-[#E9EDF7] rounded-sm text-[#e54f38] cursor-pointer"
                                            data-view-id="{{view_id|safe}}"
                                            title="{% trans "Select Row" %}"
                                            value = "{{instance.pk}}"
                                            onclick="
                                                event.stopPropagation();
                                            "
                                            onchange="
                                                element = $(this)
                                                highlightRow(element);
                                                $(document).ready(function () {
                                                    if (!element.is(':checked')) {
                                                    removeId(element)
                                                    }
                                                    reloadSelectedCount($('#count_{{view_id|safe}}'),'{{selected_instances_key_id}}');
                                                    reloadSelectedCount($('.count_{{view_id|safe}}'),'{{selected_instances_key_id}}');
                                                });
                                            "
                                        />
                                    </td>
                                    {% endif %}
                                    {% for cell in columns %}
                                        {% with attribute=cell.1 index=forloop.counter %}
                                            <td class="text-sm text-left p-3 text-[#666]
                                                {% if cell.1 == "attendance_date" %}
                                                    {% if 'attendance_date' in instance.requested_fields or instance.request_type == 'create_request' %}
                                                        diff-cell
                                                    {% endif %}
                                                    dateformat_changer
                                                    {% elif cell.1 == "attendance_day" %}
                                                    {% if 'attendance_day' in instance.requested_fields or instance.request_type == 'create_request' %}
                                                        diff-cell
                                                    {% endif %}
                                                {% elif cell.1 == "attendance_clock_in" %}
                                                    {% if 'attendance_clock_in' in instance.requested_fields or instance.request_type == 'create_request' %}
                                                        diff-cell
                                                    {% endif %}
                                                    timeformat_changer
                                                {% elif cell.1 == "attendance_clock_in_date" %}
                                                    {% if 'attendance_clock_in_date' in instance.requested_fields or instance.request_type == 'create_request' %}
                                                        diff-cell
                                                    {% endif %}
                                                    dateformat_changer
                                                {% elif cell.1 == "attendance_clock_out" %}
                                                    {% if 'attendance_clock_out' in instance.requested_fields or instance.request_type == 'create_request' %}
                                                        diff-cell
                                                    {% endif %}
                                                    timeformat_changer
                                                {% elif cell.1 == "attendance_clock_out_date" %}
                                                    {% if 'attendance_clock_out_date' in instance.requested_fields or instance.request_type == 'create_request' %}
                                                        diff-cell
                                                    {% endif %}
                                                    dateformat_changer
                                                {% elif cell.1 == "shift_id" %}
                                                    {% if 'shift_id' in instance.requested_fields or instance.request_type == 'create_request' %}
                                                        diff-cell
                                                    {% endif %}
                                                {% elif cell.1 == "work_type_id" %}
                                                    {% if 'work_type_id' in instance.requested_fields or instance.request_type == 'create_request' %}
                                                        diff-cell
                                                    {% endif %}
                                                {% elif cell.1 == "minimum_hour" %}
                                                    {% if 'minimum_hour' in instance.requested_fields or instance.request_type == 'create_request' %}
                                                        diff-cell
                                                    {% endif %}
                                                {% elif cell.1 == "attendance_worked_hour" %}
                                                    {% if 'attendance_worked_hour' in instance.requested_fields or instance.request_type == 'create_request' %}
                                                        diff-cell
                                                    {% endif %}
                                                {% elif cell.1 == "attendance_overtime" %}
                                                    {% if 'attendance_overtime' in instance.requested_fields or instance.request_type == 'create_request' %}
                                                        diff-cell
                                                    {% endif %}
                                                {% endif %}
                                                "
                                            >
                                                {% if not cell.2 %}
                                                    {{instance|getattribute:attribute|selected_format:request.user.employee_get.employee_work_info.company_id|safe}}
                                                {% else %}
                                                    <div class="oh-profile oh-profile--md">
                                                        <div class="oh-profile__avatar mr-1">
                                                            <img
                                                                src="{{instance|getattribute:cell.2}}"
                                                                alt=""
                                                                class="oh-profile__image oh-table-img"
                                                                width="30"
                                                            />
                                                        </div>
                                                        <span>{{instance|getattribute:attribute|safe}}</span>
                                                    </div>
                                                {% endif %}
                                            </td>
                                        {% endwith %}
                                    {% endfor %}

                                    {% if options or option_method %}
                                        <td class="text-sm text-center p-3 text-[#666]"
                                            onclick="event.stopPropagation()"
                                        >
                                            {% if not option_method %}
                                                <div class="flex justify-center gap-1">
                                                    {% for option in options %}
                                                        {% if option.accessibility|accessibility:instance %}
                                                            <a
                                                                href="#"
                                                                title="{{option.option|safe}}"
                                                                {{option.attrs|format:instance|safe}}
                                                            >
                                                                <ion-icon name="{{option.icon}}"></ion-icon>
                                                            </a>
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% comment %} <button
                                                        class="cursor-pointer px-2 py-1 text-xs bg-[#07bd072e] text-[#00c700] rounded-sm w-6 h-6 flex items-center justify-center ">
                                                        <i class="fa-solid fa-check"></i>
                                                    </button>
                                                    <button
                                                        class="cursor-pointer px-2 py-1 text-xs bg-[#ff000024] text-[red] rounded-sm w-6 h-6 flex items-center justify-center ">
                                                        <i class="fa-solid fa-xmark"></i>
                                                    </button> {% endcomment %}
                                                </div>
                                            {% else %}
                                                {{instance|getattribute:option_method|safe}}
                                            {% endif %}

                                        </td>
                                    {% endif %}

                                    {% if actions or action_method %}
                                        <td class="stickyright text-sm text-center p-3 text-[#666] flex"
                                            onclick="event.stopPropagation()"
                                        >
                                            {% if not action_method %}
                                                <div class="flex justify-center gap-1">
                                                    {% for action in actions %}
                                                        {% if action.accessibility|accessibility:instance %}
                                                            <a
                                                                title="{{action.action|safe}}"
                                                                {{action.attrs|format:instance|safe}}
                                                            >
                                                                <ion-icon name="{{action.icon}}"></ion-icon>
                                                            </a>
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% comment %} <button
                                                        class="cursor-pointer px-2 py-1 text-xs bg-[#07bd072e] text-[#00c700] rounded-sm w-6 h-6 flex items-center justify-center ">
                                                        <i class="fa-solid fa-check"></i>
                                                    </button>
                                                    <button
                                                        class="cursor-pointer px-2 py-1 text-xs bg-[#ff000024] text-[red] rounded-sm w-6 h-6 flex items-center justify-center ">
                                                        <i class="fa-solid fa-xmark"></i>
                                                    </button> {% endcomment %}
                                                </div>
                                            {% else %}
                                                {{instance|getattribute:action_method|safe}}
                                            {% endif %}

                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if queryset.paginator.count %}
                    <div
                        class="flex justify-between items-center mt-4 w-full inset-0"
                    >
                        <p class="text-xs text-[#666]">{% trans "Page" %} {{ queryset.number }} {% trans "of" %} {{ queryset.paginator.num_pages }}</p>
                        <div class="flex gap-3 text-[#666] items-center">
                            {% if queryset.has_previous %}
                                <button
                                    class="text-xs hover:text-primary-600 transition duration-300"
                                    hx-target="#{{view_id}}"
                                    hx-get="{{search_url}}?{{request.GET.urlencode}}&page={{ queryset.previous_page_number }}"
                                >
                                    <i class="fa-solid fa-arrow-left"></i>
                                </button>
                            {% endif %}
                            {{ queryset.number }} / {{ queryset.paginator.num_pages }}
                            {% if queryset.has_next %}
                                <button
                                    class="text-xs hover:text-primary-600 transition duration-300"
                                    hx-target="#{{view_id}}"
                                    hx-get="{{search_url}}?{{request.GET.urlencode}}&page={{ queryset.next_page_number }}"
                                >
                                    <i class="fa-solid fa-arrow-right"></i>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        {% else %}
            {% if not custom_empty_template %}
                <div class="oh-wrapper h-full" align="center" >

                    <div class="xl:col-span-4 md:col-span-6 col-span-12 bg-white p-6 rounded-md shadow-card h-[70%]">
                        <div class="flex flex-col items-center justify-center h-full">
                            <img src="/static/horilla_theme/assets/img/no-records.svg" alt="" width="300" class="mb-4">
                            <p class="text-[#666] mb-5">{% trans "No records available at the moment" %}</p>
                            {% include "generic/import_block.html" %}
                        </div>
                    </div>
                </div>
            {% else %}
                {% include custom_empty_template %}
            {% endif %}
        {% endif %}
   <script>
    reloadSelectedCount($('#count_{{view_id|safe}}'),'{{selected_instances_key_id}}');
    reloadSelectedCount($('.count_{{view_id|safe}}'),'{{selected_instances_key_id}}');
    {% if records_count_in_tab %}
    var tabId = $("#{{view_id}}").closest(".oh-tabs__content").attr("id");
    var badge = $(`#badge-${tabId}`);
    var count = "{{queryset.paginator.count}}";
    var label = badge.attr("data-badge-label") || "";
    var title = count + " " + label;
    badge.html(count);
    badge.attr("title", title);
    {% endif %}
  </script>
  {% if bulk_select_option %}
  <script>
    selectSelected("#{{view_id|safe}}",'{{selected_instances_key_id}}')
  </script>
  {% endif %}
  <script>
    $("ul[data-search-url] a").click(function (e) {
      e.preventDefault();
      const url =  $(this).attr("hx-get")
      const $urlObj = $('<a>', { href: url });
      const searchParams = new URLSearchParams($urlObj[0].search);

      let lastPageParam = null;
      let lastPageValue = 1;

      searchParams.forEach((value, param) => {
        if (param === "page") {
          lastPageParam = param;
          lastPageValue = value.split(",").pop();
        }
      });

      form = $(`form[hx-get="{{search_url}}"]`)
      pageInput = form.find("#pageInput")
      pageInput.attr("name",lastPageParam)
      pageInput.attr("value",lastPageValue)

    });
  </script>
  <script>
    $(document).ready(function () {
        attrAction = `{{header_attrs.action|safe}}`

        if (!attrAction){
            const widths = [];
            let thWidth = 0;
            $('#{{view_id}} .lastTd').each(function () {
                widths.push(this.scrollWidth);
                $(this).css('overflow', 'hidden');
            });
            widths.sort().reverse();
            if (widths.length) {
                thWidth = widths[0];
            }
            if (!thWidth) {
                thWidth = 180
            }
            $('#{{view_id}} .lastTh').css("width", `${thWidth}px`);
        }

    });
  </script>
  <script>
    setTimeout(() => {
      $("#{{view_id}} [type=checkbox].list-table-row:checked").first().change();
      $("#{{view_id}} [type=checkbox].list-table-row:checked").not().first().change();
      var ids = JSON.parse($("#{{selected_instances_key_id}}").attr("data-ids"))
      if (ids.length) {
        $("#{{view_id}} .quick-bulk-action.d-none").removeClass("d-none");
      }
    }, 200);

  </script>

</div>
