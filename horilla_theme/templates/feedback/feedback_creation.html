{% extends 'index.html' %}
{% load static i18n widget_tweaks %}
{% block styles %}
<link rel="stylesheet" href="{% static 'css/pms.css' %}" />
{% endblock styles %}
{% block content %}
{% if feedback_form.errors %}
<div class="oh-wrapper">
    <div class="oh-alert-container">
        {% for error in feedback_form.non_field_errors %}
        <div class="oh-alert oh-alert--animated oh-alert--danger">
            {{ error }}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
<style>
    .select2-selection{
        margin-bottom:18px; !important
    }
</style>
<div class="oh-wrapper" id="message"></div>

<div class="bg-white p-5 pe-2 pt-3 rounded-md shadow-card w-full lg:w-2/4 m-auto">
    <h3 class="text-lg font-semibold mb-3">{{feedback_form.verbose_name}}</h3>
    <form action="{%url 'feedback-creation' %}" id="feedbackCreationForm" method="post">
        {{feedback_form.non_field_errors}}
        {% csrf_token %}
        <div class="grid grid-cols-12 gap-4 h-[calc(100vh_-_300px)] overflow-hidden overflow-y-auto">
            <!-- Left Column -->
            <div class="col-span-12 md:col-span-6">
                <div class="p-4 border border-dark-50 rounded-md">
                    <label class="text-xs font-medium" for="{{feedback_form.review_cycle.id_for_label}}">{{feedback_form.review_cycle.label}}</label>
                    {{feedback_form.review_cycle|add_class:"mb-3 text-color-600 px-3 p-2 placeholder:text-xs w-full border border-dark-50 rounded-md focus-visible:outline-0 placeholder:text-dark-100 text-xs transition duration-300 focus:border-primary-600"}}
                    {{feedback_form.review_cycle.errors}}

                    <label class="text-xs font-medium" for="{{feedback_form.employee_id.id_for_label}}">{{feedback_form.employee_id.label}}</label>
                    {{feedback_form.employee_id|add_class:"mb-3 text-color-600 px-3 p-2 placeholder:text-xs w-full border border-dark-50 rounded-md focus-visible:outline-0 placeholder:text-dark-100 text-xs transition duration-300 focus:border-primary-600"}}
                    {{feedback_form.employee_id.errors}}

                    <label class="text-xs font-medium" for="{{feedback_form.manager_id.id_for_label}}">{{feedback_form.manager_id.label}}</label>
                    {{feedback_form.manager_id|add_class:"mb-3 text-color-600 px-3 p-2 placeholder:text-xs w-full border border-dark-50 rounded-md focus-visible:outline-0 placeholder:text-dark-100 text-xs transition duration-300 focus:border-primary-600"}}
                    {{feedback_form.manager_id.errors}}

                    <div class="flex items-center gap-1 pb-2 overflow-visible relative">
                        <label class="text-xs font-medium" for="{{feedback_form.subordinate_id.id_for_label}}">
                            {{ feedback_form.subordinate_id.label }}
                        </label>
                        <span class="oh-info" title="{{ feedback_form.subordinate_id.help_text|safe }}"></span>
                    </div>
                    {{feedback_form.subordinate_id|add_class:"mb-3 text-color-600 px-3 p-2 placeholder:text-xs w-full border border-dark-50 rounded-md focus-visible:outline-0 placeholder:text-dark-100 text-xs transition duration-300 focus:border-primary-600"}}
                    {{feedback_form.subordinate_id.errors}}

                    <div class="flex items-center gap-1 pb-2 overflow-visible relative">
                        <label class="text-xs font-medium" for="{{feedback_form.colleague_id.id_for_label}}">
                            {{ feedback_form.colleague_id.label }}
                        </label>
                        <span class="oh-info" title="{{ feedback_form.colleague_id.help_text|safe }}"></span>
                    </div>
                    {{feedback_form.colleague_id|add_class:"mb-3 text-color-600 px-3 p-2 placeholder:text-xs w-full border border-dark-50 rounded-md focus-visible:outline-0 placeholder:text-dark-100 text-xs transition duration-300 focus:border-primary-600"}}
                    {{feedback_form.colleague_id.errors}}

                    <label class="text-xs font-medium" for="{{feedback_form.others_id.id_for_label}}">{{feedback_form.others_id.label}}</label>
                    {{feedback_form.others_id|add_class:"mb-3 text-color-600 px-3 p-2 placeholder:text-xs w-full border border-dark-50 rounded-md focus-visible:outline-0 placeholder:text-dark-100 text-xs transition duration-300 focus:border-primary-600"}}
                    {{feedback_form.others_id.errors}}
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-span-12 md:col-span-6">
                <div class="p-4 border border-dark-50 rounded-md">
                    <label class="text-xs font-medium" for="{{feedback_form.period.id_for_label}}">{{feedback_form.period.label}}</label>
                    {{feedback_form.period|add_class:"mb-3 text-color-600 px-3 p-2 placeholder:text-xs w-full border border-dark-50 rounded-md focus-visible:outline-0 placeholder:text-dark-100 text-xs transition duration-300 focus:border-primary-600"}}
                    {{feedback_form.period.errors}}

                    <label class="text-xs font-medium" for="{{feedback_form.start_date.id_for_label}}">{{feedback_form.start_date.label}}</label>
                    {{feedback_form.start_date|add_class:"mb-3 text-color-600 px-3 p-2 placeholder:text-xs w-full border border-dark-50 rounded-md focus-visible:outline-0 placeholder:text-dark-100 text-xs transition duration-300 focus:border-primary-600"}}
                    {{feedback_form.start_date.errors}}

                    <label class="text-xs font-medium" for="{{feedback_form.end_date.id_for_label}}">{{feedback_form.end_date.label}}</label>
                    {{feedback_form.end_date|add_class:"mb-3 text-color-600 px-3 p-2 placeholder:text-xs w-full border border-dark-50 rounded-md focus-visible:outline-0 placeholder:text-dark-100 text-xs transition duration-300 focus:border-primary-600"}}
                    {{feedback_form.end_date.errors}}

                    <label class="text-xs font-medium" for="{{feedback_form.question_template_id.id_for_label}}">{{feedback_form.question_template_id.label}}</label>
                    {{feedback_form.question_template_id|add_class:"mb-3 text-color-600 px-3 p-2 placeholder:text-xs w-full border border-dark-50 rounded-md focus-visible:outline-0 placeholder:text-dark-100 text-xs transition duration-300 focus:border-primary-600"}}
                    {{feedback_form.question_template_id.errors}}

                    <label class="text-xs font-medium" for="{{feedback_form.employee_key_results_id.id_for_label}}">{{feedback_form.employee_key_results_id.label}}</label>
                    {{feedback_form.employee_key_results_id|add_class:"mb-3 text-color-600 px-3 p-2 placeholder:text-xs w-full border border-dark-50 rounded-md focus-visible:outline-0 placeholder:text-dark-100 text-xs transition duration-300 focus:border-primary-600"}}
                    {{feedback_form.employee_key_results_id.errors}}

                    <!-- Cyclic Feedback Toggle -->
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-xs font-medium" for="{{feedback_form.cyclic_feedback.id_for_label}}">{{feedback_form.cyclic_feedback.label}}</label>
                        <label class="inline-flex items-center cursor-pointer gap-3">
                            {{feedback_form.cyclic_feedback|add_class:"sr-only peer"}}
                            <div class="relative w-9 h-5 bg-[#aeaeb2] rounded-full peer-checked:bg-[#e54f38]
                                after:content-[''] after:absolute after:top-[2px] after:left-[2px]
                                after:bg-white after:rounded-full after:h-4 after:w-4
                                after:transition-all peer-checked:after:translate-x-4 peer-checked:after:border-white">
                            </div>
                        </label>
                        {{feedback_form.cyclic_feedback.errors}}
                    </div>
                    <div id="cyclic_feedback_period">
                        <label class="text-xs font-medium" for="{{feedback_form.cyclic_feedback_days_count.id_for_label}}">{{feedback_form.cyclic_feedback_days_count.label}}</label>
                            {{feedback_form.cyclic_feedback_days_count|add_class:"mb-3 text-color-600 px-3 p-2 placeholder:text-xs w-full border border-dark-50 rounded-md focus-visible:outline-0 placeholder:text-dark-100 text-xs transition duration-300 focus:border-primary-600"}}
                            {{feedback_form.cyclic_feedback_days_count.errors}}
                    </div>
                </div>
            </div>
        </div>

        <div class="flex gap-1 justify-end pt-3 mt-3">
            <button type="submit"
                class="px-4 py-2 bg-primary-600 text-white rounded-md text-xs flex items-center gap-2 hover:bg-primary-800 transition duration-300">
                Save
            </button>
        </div>
    </form>
</div>

<!-- period modal -->
<div
    class="oh-modal"
    id="PeriodModal"
    role="dialog"
    aria-labelledby="editKeyResultModal"
    aria-hidden="true"
>
    <div class="oh-modal__dialog">
        <!-- for creating period -->
        <div class="oh-modal__dialog-header">
            <button
                type="button"
                class="oh-modal__close"
                aria-label="Close"
            >
                <ion-icon name="close-outline"></ion-icon>
            </button>
        </div>
        <div class="oh-modal__dialog-body" id="periodModalTarget"></div>
    </div>
</div>
<!-- end of period modal -->
<button
    id="colleguesButton"
    hx-get="{% url 'get-collegues' %}"
    hx-target="#id_colleague_id"
    hidden
></button>
<button
    id="managerButton"
    hx-get="{% url 'get-collegues' %}"
    hx-target="#id_manager_id"
    hidden
></button>
<button
    id="subordinatesButton"
    hx-get="{% url 'get-collegues' %}"
    hx-target="#id_subordinate_id"
    hidden
></button>
<button
    id="keyresultButtton"
    hx-get="{% url 'get-collegues' %}"
    hx-target="#id_employee_key_results_id"
    hidden
></button>

<script>
    $(document).ready(function () {
        get_collegues($("#id_employee_id"));
        setTimeout(function () {
            select = $("select");
            select.siblings("span.select2.select2-container").remove();
            select.select2();
        }, 700);
    });
    function get_collegues(element) {
        var employee_id = $(element).val();

        // Check if the employee_id is valid

        // Dynamically set the hx-vals attribute for the manager, colleagues, subordinates, keyresult buttons
        if (employee_id) {
            $("#managerButton")
                .attr(
                    "hx-vals",
                    JSON.stringify({
                        employee_id: employee_id,
                        data: "manager",
                    })
                )
                .click();
            $("#colleguesButton")
                .attr(
                    "hx-vals",
                    JSON.stringify({
                        employee_id: employee_id,
                        data: "colleagues",
                    })
                )
                .click();
            $("#subordinatesButton")
                .attr(
                    "hx-vals",
                    JSON.stringify({
                        employee_id: employee_id,
                        data: "subordinates",
                    })
                )
                .click();
            $("#keyresultButtton")
                .attr(
                    "hx-vals",
                    JSON.stringify({
                        employee_id: employee_id,
                        data: "keyresults",
                    })
                )
                .click();
        } else {
            console.error("Invalid employee_id");
        }
    }
    $(document).ready(function(){
        $("#feedbackCreationForm").find("select").select2({
            width:'100%'
        })
    })
</script>

<script src="{% static 'src/feedback/feedback_creation.js' %}"></script>
<script src="{% static 'src/period/period.js' %}"></script>
{% endblock%}
