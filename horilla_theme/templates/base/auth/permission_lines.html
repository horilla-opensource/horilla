{% load basefilters i18n %}
<div class="accordion-wrapper space-y-2">
    {% for employee in employees %}
        <div class="accordion-item border border-primary-300 rounded-md perm-accordion" id="userPanel{{employee.id}}">
            <button
                onclick="event.preventDefault()"
                class="accordion-btn-gp w-full flex justify-between gap-5 md:gap-0 items-center flex-wrap px-4 py-2 bg-primary-100 text-primary-600 text-sm transition-all"
            >
                <div class="flex flex-wrap items-center gap-2">
                    <span class="w-6 h-6 bg-primary-600 rounded-full text-white flex items-center justify-center text-xs">
                        <img src="{{ employee.get_avatar }}" class="w-6 h-6 rounded-full" loading="lazy" />
                    </span>
                    <span class="font-semibold">{{ employee }}</span>
                    <span class="text-xs mt-1 text-dark-300">
                        {{ employee.employee_work_info.job_role_id.job_role }} |
                        {{ employee.employee_work_info.job_position_id }} |
                        {{ employee.employee_work_info.department_id }}
                    </span>
                </div>
                <div class="flex items-center flex-wrap gap-2 md:gap-8">
                    <span class="icon text-xl font-bold">+</span>
                </div>
            </button>

            <div class="panel view-employees accordion-panel-gp max-h-0 overflow-hidden transition-all duration-300 bg-white px-4 text-sm text-gray-700" id="panel{{employee.id}}" data-user-id="{{ employee.id }}">
                <div class="py-3">
                    <script>
                        $(document).ready(function () {
                            checkSelected(`{{employee.employee_user_id.user_permissions.all|user_perms|safe}}`, '#panel{{employee.id}}', true)
                        })
                    </script>
                    {% if perms.auth.add_permission or perms.auth.change_permission or perms.auth.delete_permission %}
                        {% include 'base/auth/permission_table.html' %}
                    {% endif %}
                </div>
            </div>
        </div>
    {% endfor %}

    {% if employees.has_previous or employees.has_next %}
        <div
            class="flex justify-between items-center mt-4 w-full inset-0"
        >
            <p class="text-xs text-[#666]">{% trans "Page" %} {{ employees.number }} {% trans "of" %} {{ employees.paginator.num_pages }}</p>
            <div class="flex gap-3 text-[#666] items-center">
                {% if employees.has_previous %}
                    <button
                        class="text-xs hover:text-primary-600 transition duration-300"
                        hx-target="#permissionContainer"
                        hx-get="{% url 'permission-search' %}?{{ pd }}&page={{ employees.previous_page_number }}"
                    >
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                {% endif %}
                <div>
                    <input
                        type="number"
                        name="page"
                        class="w-[30px]"
                        value="{{employees.number}}"
                        hx-get="{% url 'permission-search' %}?{{pd}}"
                        hx-target="#permissionContainer"
                        min="1"
                    /> / {{ employees.paginator.num_pages }}
                </div>
                {% if employees.has_next %}
                    <button
                        class="text-xs hover:text-primary-600 transition duration-300"
                        hx-target="#permissionContainer"
                        hx-get="{% url 'permission-search' %}?{{ pd }}&page={{ employees.next_page_number }}"
                    >
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>
<script>
  document.body.addEventListener("htmx:afterSwap", function () {
    updateBadge();
  });

  var timeout;
  function selectAllPermissions(source) {
    const isChecked = $(source).is(':checked');
    const table = $(source).closest('table'); // or your specific container
    table.find('tbody input.row-permission').prop('checked', isChecked).trigger('change');
  }

  function updatePermissions(panelElem) {
    var userId = panelElem.data("user-id");
    var permissions = [];

    panelElem.find("[name=permissions]").each(function () {
      permissions.push({
        codename: $(this).val(),
        checked: $(this).is(":checked")
      });
    });

    $.ajax({
      type: "post",
      url: '{% url "update-user-permission" %}',
      contentType: "application/json",
      data: JSON.stringify({
        permissions: permissions,
        employee: userId,
      }),
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
      },
      success: function (response) {
        reloadMessage()
      },
      error: function () {
        reloadMessage()
      }
    });
  }

  $(document).ready(function () {
    updateBadge();
    var timeout;
    $(".view-employees [name=permissions]").on("change", function (e) {
      e.preventDefault();
      clearTimeout(timeout);

      const panel = $(this).closest(".panel.view-employees");

      timeout = setTimeout(() => {
        updateBadge();
        updatePermissions(panel);  // ✅ pass correct panel
      }, 100);
    });
  });


  function updateBadge() {
    // Loop through each employee panel
    $(".accordion-wrapper").each(function () {
      const wrapper = $(this);

      // For each permission panel
      wrapper.find(".panel").each(function () {
        const panel = $(this);
        const badge = panel.prev(".inner-accordion-toggle").find(".permission-badge");
        const checkedCount = panel.find("[name=permissions]:checked").length;

        badge.text(checkedCount);
        badge.attr("title", checkedCount + " Permissions");
      });

      // Update row-permission checkboxes (4 perms = checked)
      wrapper.find("tbody tr").each(function () {
        const row = $(this);
        const rowPermissionCheckbox = row.find(".row-permission");
        const checkedCount = row.find("[name=permissions]:checked").length;

        rowPermissionCheckbox.prop("checked", checkedCount === 4);
      });

      // Update "Select All" checkboxes
      wrapper.find("table").each(function () {
        const table = $(this);
        const allCheckboxes = table.find("tbody [name=permissions]");
        const checkedCheckboxes = table.find("tbody [name=permissions]:checked");
        const selectAll = table.find(".row-permission__select-all");

        selectAll.prop("checked", allCheckboxes.length === checkedCheckboxes.length);
      });
    });
  }



</script>

<!-- ACCORDION -->
<script>
  // Outer accordion logic (no change needed)
  document.querySelectorAll('.accordion-btn-gp').forEach((btn) => {
      btn.addEventListener('click', () => {
          const panel = btn.nextElementSibling;
          const icon = btn.querySelector('.icon');
          const isOpen = panel.style.maxHeight && panel.style.maxHeight !== "0px";

          document.querySelectorAll('.accordion-panel-gp').forEach(p => {
              if (p !== panel) {
                  p.style.maxHeight = null;
                  const i = p.previousElementSibling.querySelector('.icon');
                  if (i) i.textContent = '+';
                  p.previousElementSibling.classList.remove("bg-primary-600", "text-white");
                  p.previousElementSibling.classList.add("bg-primary-100", "text-primary-600");
              }
          });

          if (!isOpen) {
              panel.style.maxHeight = panel.scrollHeight + 'px';
              icon.textContent = '−';
              btn.classList.add("bg-primary-100", "text-primary-600");
          } else {
              panel.style.maxHeight = null;
              icon.textContent = '+';
              btn.classList.remove("bg-primary-600", "text-white");
              btn.classList.add("bg-primary-100", "text-primary-600");
          }
      });
  });

  // Inner accordion logic (supports multiple)
  document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('.inner-accordion-toggle').forEach((toggle) => {
          const content = toggle.nextElementSibling;

          toggle.addEventListener("click", () => {
              const isOpen = content.style.maxHeight && content.style.maxHeight !== "0px";

              if (isOpen) {
                  content.style.maxHeight = "0";
                  content.style.opacity = "0";
              } else {
                  content.style.maxHeight = content.scrollHeight + "px";
                  content.style.opacity = "1";
              }

              // Adjust parent height (if inside outer accordion)
              const outerPanel = toggle.closest('.accordion-panel-gp');
              if (outerPanel) {
                  setTimeout(() => {
                      outerPanel.style.maxHeight = outerPanel.scrollHeight + "px";
                  }, 250);
              }
          });
      });
  });
</script>
