{% load i18n static %}
{% load generic_template_filters %}

<script>
    function enlargeDoc(src, $element) {
        var enlargeDocContainer = $('#detailViewContainer').find("#enlargeattachmentContainer");
        enlargeDocContainer.empty();

        var style = 'width:100%; height:100%; border:none; box-shadow: 0 10px 10px rgba(0,0,0,0.2), 0 6px 20px rgba(0,0,0,0.2); background:white;';
        var iframe = $('<iframe>', {
            src: src,
            style: style
        });

        var filename = src.split('/').pop().replace(/_/g, ' ');
        var name = $('<span>').text(filename).css({
            display: 'block',
            textAlign: 'center',
            marginTop: '10px',
            fontWeight: 'bold'
        });

        enlargeDocContainer.append(iframe).append(name).show();
    }

    function hideEnlargeDoc() {
        var enlargeDocContainer = $('#enlargeattachmentContainer')
        enlargeDocContainer.empty()
    }

    $(document).on('click', function (event) {
        if (!$(event.target).closest('#enlargeattachmentContainer').length) {
            hideEnlargeDoc()
        }
    })
</script>

<div
    class="modal-box px-5 bg-white w-full max-w-md md:min-w-[700px] rounded-lg shadow-card p-0 transition-all duration-300 opacity-100 scale-100"
>
    <div class="py-5" id="detailViewContainer">
        <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg font-semibold text-gray-900">{% trans "Announcement" %}</h2>
            <button class="text-gray-500 hover:text-red-500 text-xl"
                onclick="$(this).closest('.oh-modal--show').removeClass('oh-modal--show');">
                <img src="{% static 'horilla_theme/assets/icons/close.svg' %} " alt="" />
            </button>
        </div>

        <div class="bg-white border border-gray-300 rounded-xl shadow-sm max-w-4xl mx-auto relative mt-2">

            <div class="px-6 pt-5 pb-4 border-b border-gray-300">
                <div class="flex justify-between items-start mb-3 flex-wrap md:flex-nowrap">
                    <h5 class="text-xl font-extrabold text-gray-900 flex-1 md:mr-4 mb-2 md:mb-0">{{instance.title}} </h5>
                    {% if perms.base.change_announcement or perms.base.delete_announcement %}
                    <div x-data="{open: false}">
                        <button class="oh-btn oh-stop-prop oh-btn--transparent oh-accordion-meta__btn" @click="open = !open"
                            @click.outside="open = false" title="{% trans 'Actions' %}"
                        >
                            <ion-icon name="ellipsis-vertical"></ion-icon>
                        </button>

                        <div class="oh-dropdown__menu oh-dropdown__menu--right" x-show="open">
                            <ul class="oh-dropdown__items">
                                {% if perms.base.change_announcement %}
                                    <li class="oh-dropdown__item">
                                        <a hx-get="{% url 'update-announcement' announcement.id %}?instance_ids={{instance_ids}}" hx-target='#objectUpdateModalTarget'
                                            data-toggle='oh-modal-toggle' data-target="#objectUpdateModal"
                                            class="oh-dropdown__link" style="cursor:pointer;">{% trans "Edit" %}</a>
                                    </li>
                                {% endif %}
                                {% if perms.base.delete_announcement %}
                                    <li class="oh-dropdown__item">
                                        <form hx-post="{% url 'delete-announcement' announcement.id %}?instance_ids={{instance_ids}}"
                                            hx-confirm="{% trans 'Are you sure you want to delete this announcement?' %}"
                                            hx-target="#objectDetailsModalTarget">
                                            {% csrf_token %}
                                            <button type="submit" class="oh-dropdown__link oh-dropdown__link--danger" data-action="delete">
                                                {% trans "Delete" %}
                                            </button>
                                        </form>
                                    </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="flex justify-between">
                    <div class="text-gray-500 text-sm font-medium mt-1">
                        <small>{% trans "Posted on" %} <span class="dateformat_changer">{{ announcement.created_at.date}}</span> {% trans "at" %} <span class="timeformat_changer">{{ announcement.created_at.time}}</span></small>
                    </div>
                    {% if perms.base.view_announcement %}
                        <div class="inline-flex items-center gap-1 bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-medium cursor-pointer mt-2 hover:bg-blue-200"
                            hx-get="{% url 'announcement-viewed-by' %}?announcement_id={{announcement.id}}"
                            title="{{announcement.get_views|length}} Views"
                            data-toggle="oh-modal-toggle"
                            hx-target="#objectCreateModalTarget"
                            data-target="#objectCreateModal"
                        >
                            <span>{{announcement.get_views|length}}</span>
                            <span><ion-icon name="eye-outline"></ion-icon></span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="px-4 py-6 max-h-[300px] overflow-auto">
                <span class=" block font-semibold text-sm mb-2 text-[#565E6C] w-32">
                    {% trans "Description" %}
                </span>
                <div class="text-gray-700 text-base leading-relaxed px-2">
                    {{ announcement.description|safe }}
                </div>
            </div>

            <div class="flex gap-1 mt-3 text-sm text-gray-600 flex-wrap pl-5 mb-3">
                {% for attachment in instance.attachments.all %}
                    {% with extension=attachment.file.name|lower|slice:"-4:" %}
                        <a href="{{ attachment.file.url }}" target="_blank" class="oh-helpdesk__icon">
                            <span
                                title="{{ attachment }}"
                                class="oh-file-icon
                                {% if extension == '.pdf' %} oh-file-icon--pdf
                                {% elif extension in '.jpg .jpeg .png .gif .svg' %} oh-file-icon--image
                                {% elif extension in '.mp3 .wav .ogg' %} oh-file-icon--audio
                                {% elif extension in '.doc .docx' %} oh-file-icon--word
                                {% elif extension in '.xls .xlsx' %} oh-file-icon--excel
                                {% elif extension in '.ppt .pptx' %} oh-file-icon--powerpoint
                                {% elif extension in '.html' %} oh-file-icon--html
                                {% else %} oh-file-icon--default
                                {% endif %}"
                                onmouseover="enlargeDoc('{{ attachment.file.url }}',$(this))"
                                {% comment %} onmouseout="hideEnlargeDoc()" {% endcomment %}
                            >
                            </span>
                        </a>
                    {% endwith %}
                {% endfor %}
            </div>

            <div class="flex justify-between items-center px-4 py-4 bg-gray-100 rounded-xl mx-2 mb-3">
                    <div class="flex gap-2 ">
                        {% if announcement.department.all or announcement.job_position.all %}
                            <button class="bg-blue-200 text-blue-800 oh-btn rounded-md text-sm flex items-center gap-1 hover:bg-blue-300 transition-colors duration-200"
                                onmouseover="$('#tagsInfo').removeClass('hidden')" onmouseout="$('#tagsInfo').addClass('hidden')"
                            >
                                <ion-icon name="information-outline"></ion-icon>
                            </button>
                        {% endif %}

                        {% if announcement.disable_comments %}
                            <button class="bg-gray-200 text-gray-900 oh-btn oh-btn--disabled rounded-md text-sm flex items-center gap-1 hover:bg-gray-300 transition-colors duration-200"
                                title="{% trans 'Comments disabled' %}"
                            >
                                <ion-icon name="chatbox-outline" style="font-size:18px;" ></ion-icon>
                                {% trans "Comments" %}
                            </button>
                        {% else %}
                            <button class="bg-gray-200 text-gray-700 oh-btn rounded-md text-sm flex items-center gap-1 hover:bg-gray-300 transition-colors duration-200"
                                hx-get="{% url 'announcement-view-comment' instance.id %}"
                                hx-target="#genericOffCanvas"
                                data-target='#genericSidebar'
                                onclick="$('#genericSidebar').addClass('oh-activity-sidebar--show')"
                                title="{% trans 'Comments' %}"
                            >
                                <ion-icon name="chatbox-outline" style="font-size:18px;" ></ion-icon>
                                {% trans "Comments" %}
                            </button>
                        {% endif %}
                    </div>

                    <div class="flex flex-wrap justify-between gap-2 md:gap-1">
                        {% if instance_ids %}
                            <div class="flex gap-1 ml-auto">
                                <button data-action="previous"
                                    hx-get="{{ previous_url }}?{{ ids_key }}={{ instance_ids }}{% if extra_query %}&{{ extra_query }}{% endif %}"
                                    hx-target="#objectDetailsModalTarget"
                                    class="p-2 w-8 h-8 justify-center bg-primary-600 text-white rounded-full text-xs flex items-center gap-2 hover:bg-primary-800 transition duration-300">
                                    <i class="fa-solid fa-angle-left"></i>
                                </button>
                                <button data-action="next"
                                    hx-get="{{ next_url }}?{{ ids_key }}={{ instance_ids }}{% if extra_query %}&{{ extra_query }}{% endif %}"
                                    hx-target="#objectDetailsModalTarget"
                                    class="p-2 w-8 h-8 justify-center bg-primary-600 text-white rounded-full text-xs flex items-center gap-2 hover:bg-primary-800 transition duration-300">
                                    <i class="fa-solid fa-angle-right"></i>
                                </button>
                            </div>
                        {% endif %}
                    </div>
            </div>

            <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-4 my-3 mx-2 hidden" id="tagsInfo">
                <div class="mb-3 last:mb-0">
                    {% if announcement.department.all %}
                        <div class="text-xs font-semibold text-yellow-800 uppercase mb-1">{% trans "Department" %}</div>
                        <div class="flex flex-wrap gap-1">
                            {% for dep in announcement.department.all %}
                                <span class="bg-yellow-400 text-yellow-900 px-2 py-0.5 rounded-full text-xs font-medium">#{{dep.department}}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div>
                    {% if announcement.job_position.all %}
                        <div class="text-xs font-semibold text-yellow-800 uppercase mb-1">{% trans "Job Position" %}</div>
                        <div class="flex flex-wrap gap-1">
                            {% for job in announcement.job_position.all %}
                                <span class="bg-yellow-400 text-yellow-900 px-2 py-0.5 rounded-full text-xs font-medium">#{{job.job_position}}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>

        <div class="m-3 max-h-[200px]" id="enlargeattachmentContainer"></div>
    </div>
</div>
