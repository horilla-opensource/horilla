{% load static %}{% load i18n %} {% load basefilters %}
{% if messages %}
    <script>reloadMessage();</script>
{% endif %}
<script>
    function submitForm(elem) {
        $(elem).siblings('.add_more_submit').click()
    }
    function enlargeDoc(src, $element) {
        var enlargeDocContainer = $element.parents().closest("li").find("#enlargeDocContainer")
        enlargeDocContainer.empty()
        style = 'width:100%; height:90%; box-shadow: 0 10px 10px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.2); background:white'
        var enlargedImage = $('<iframe>').attr({ src: src, style: style })
        var name = $('<span>').text(src.split('/').pop().replace(/_/g, ' '))
        enlargeDocContainer.append(enlargedImage)
        enlargeDocContainer.append(name)
        setTimeout(function () {
            enlargeDocContainer.show()

            const iframe = document.querySelector('iframe').contentWindow
            var iframe_document = iframe.document
            iframe_image = iframe_document.getElementsByTagName('img')[0]
            $(iframe_image).attr('style', 'width:100%; height:100%;')
        }, 100)
    }

    function hideEnlargeDoc() {
        var enlargeDocContainer = $('.enlargeDocContainer')
        enlargeDocContainer.empty()
    }

    $(document).on('click', function (event) {
        if (!$(event.target).closest('#enlargeDocContainer').length) {
            hideEnlargeDoc()
        }
    })
</script>
<style>
    .enlarge-image-container {
        display: none;
        position: fixed;
        top: 40%;
        left: 40%;
        transform: translate(-50%, -50%);
        width: 30%;
        height: 50%;
        z-index: 9999;
    }
</style>

{% if notes %}
    <div class="bg-white rounded-md shadow-card p-3 mb-5 lg:mb-0">
        <!-- Title -->
        <div class="flex items-center justify-between mb-3">
            <h5 class="font-semibold text-sm">{{ employee }}'s {% trans "Notes" %}</h5>
        </div>

        <!-- Add Note Form -->
        {% if perms.employee.add_employeenote or request.user|is_reportingmanager %}
        <form hx-target="#note_target" hx-post="{% url 'add-employee-note' employee.id %}" id="commentForm">
            {% csrf_token %}
            <input type="text" name="description" id="commentInput"
                class="oh-input w-full mt-2" placeholder="{% trans 'Add notes' %}" hx-on:keyup="toggleCommentButton(this);">
            <button type="submit" id="commentButton"
                class="oh-btn oh-btn--secondary mt-2"
                style="display: none;">
                <i class="fa-regular fa-square-plus"></i>
                {% trans "Add" %}
            </button>
        </form>
        {% endif %}

        <!-- Notes List -->
        <div class="h-[calc(100vh_-_480px)] overflow-hidden overflow-y-auto mt-4" id="note_target">
            {% for note in notes %}
                <div class="border border-dark-50 p-3 rounded-md mb-2" id="employeeNote{{note.id}}">
                    <div class="flex justify-between">
                        <h3 class="font-semibold text-sm">{{ note.description }}</h3>
                        {% if perms.employee.delete_employeenote or request.user|is_reportingmanager %}
                        <form method="POST"
                                hx-post="{% url 'employee-note-delete' note.id %}"
                                hx-confirm="{% trans 'Are you sure you want to delete this note?' %}"
                                hx-target="#note_target"
                                hx-swap="outerHTML"
                                class="inline-block">
                            {% csrf_token %}
                            <button type="submit" class="cursor-pointer bg-transparent border-0 p-0" title="{% trans 'Delete' %}">
                                <ion-icon name="trash-outline" style="color: #e54f38;"></ion-icon>
                            </button>
                        </form>


                        {% endif %}
                    </div>

                    {% if perms.employee.view_notefiles or request.user|is_reportingmanager %}
                    <div class="flex flex-wrap items-center gap-2 mt-2 mb-2">
                        {% for file in note.note_files.all %}
                        <a href="{{ file.files.url }}" target="_blank" rel="noopener noreferrer">
                            <span class="oh-file-icon oh-file-icon--pdf" id="noteFile{{file.id}}"
                                onmouseover="enlargeDoc('{{ file.files.url }}',$(this))"
                                onmouseout="hideEnlargeDoc()" style="width: 40px; height: 40px;">
                                {% if perms.employee.delete_notefiles or request.user|is_reportingmanager %}
                                <img src="{% static 'images/ui/minus-icon.png' %}"
                                    style="display: block; width: 50%; height: 50%;"
                                    hx-get="{% url 'delete-employee-note-file' file.id %}" hx-target="#noteFile{{file.id}}"
                                    hx-swap="delete" onclick="event.stopPropagation();event.preventDefault()" />
                                {% endif %}
                            </span>
                        </a>
                        {% endfor %}
                        {% if perms.employee.add_notefiles or request.user|is_reportingmanager %}
                        <form hx-post="{% url 'add-more-files-employee' note.id %}" class="add-files-form"
                            hx-encoding="multipart/form-data" hx-swap="innerHTML" hx-target="#note_target">
                            {% csrf_token %}
                            <label for="addFile_{{note.id}}" title="{% trans "Add Files" %}">
                                <ion-icon name="add-outline" style="font-size: 12px;border: 1px solid #818791; border-radius: 5px;"
                                class="text-gray-700"></ion-icon>
                            </label>
                            <input type="file" name="files" class="d-none" multiple id="addFile_{{note.id}}"
                                onchange="submitForm(this)">
                            <input type="submit" class="d-none add_more_submit" value="save" />
                        </form>
                        {% endif %}
                    </div>
                    {% endif %}

                    <p class="text-xs text-[#565E6C] mt-1">
                        {% trans "By" %} <span class="text-primary-600">{{ note.updated_by }}</span>
                    </p>
                    <p class="text-xs text-[#565E6C] mt-1">
                        {% trans "At" %} {{ note.created_at|date:"d/m/Y" }} {{ note.created_at|time:"H:i A" }}
                    </p>
                </div>
            {% endfor %}
        </div>
    </div>
{% else %}
    <div class="mt-4">
        <form hx-target="#note_target" hx-post="{% url 'add-employee-note' employee.id %}"
            id="commentForm">
            {% csrf_token %}
            <div>
                <div class="mt-4">
                    <span class="text-md font-semibold mb-3">{{employee}}'s {% trans "Notes" %}</span>
                    {% if perms.employee.add_employeenote or request.user|is_reportingmanager %}
                    <input type="text" hx-on:keyup="toggleCommentButton(this);" name="description" id="commentInput"
                        class="oh-input w-100 mt-2" placeholder="{% trans 'Add notes' %}">
                    {% endif %}
                </div>
                <button type="submit" id="commentButton" class="oh-btn oh-btn--secondary mt-2 mr-0 oh-btn--w-100-resp"
                    style="display: none;">
                    {% trans "Add" %}
                </button>
            </div>
            <div class="oh-inner-sidebar-content__footer"></div>
        </form>
    </div>

    <div class="oh-wrapper h-full" align="center">
        <div class="xl:col-span-4 md:col-span-6 col-span-12 bg-white p-6 rounded-md shadow-card h-[70%]">
            <div class="flex flex-col items-center justify-center h-full">
                <img src="/static/horilla_theme/assets/img/no-records.svg" alt="" width="300" class="mb-4">
                <p class="text-[#666] mb-5">{% trans "No notes have been added for this employee" %}</p>
            </div>
        </div>
    </div>
{% endif %}
