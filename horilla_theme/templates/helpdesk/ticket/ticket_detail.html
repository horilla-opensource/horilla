{% extends 'index.html' %}
{% load static i18n audit_filters basefilters helpdeskfilters %}
{% block content %}

<div id="ohMessages"></div>

<div class="grid grid-cols-12 gap-4 h-full">
    <!-- Left Column: 6/12 -->
    <div class="col-span-12 lg:col-span-3 border-r border-dark-50 pe-4">
        <div class="bg-white rounded-md shadow-card p-3">
            <div
                class="h-[calc(100vh_-_200px)] overflow-hidden overflow-y-auto p-3"
            >
                <div class="flex items-center justify-between p-3">
                    <h3 class="text-lg font-semibold">{{ticket.title|title}}</h3>
                    <div class="relative">
                        <div class="w-[100px]">
                            {% if perms.helpdesk.change_ticket or request.user.employee_get|is_department_manager:ticket or request.user.employee_get in ticket.assigned_to.all or request.user.employee_get == ticket.employee_id %}
                                <select name="status_update" title="{% trans 'Status' %}" class="oh-select" data-ticket="{{ticket.id}}"
                                    onchange="updateStatus(this)" style=" width:190px; align-items: center; border: 1px solid #aaa; border-radius: 2px; background-color: #fff; ">
                                    {% for status in ticket_status %}
                                        <option value="{{status.0}}" {% if status.0 == ticket.status %} selected {% endif %}>
                                            <span class="oh-dot oh-dot--small oh-dot--warning">{{status.1}}</span>
                                        </option>
                                    {% endfor %}
                                </select>
                            {% else %}
                                <button class="oh-input">{{ticket.get_status_display}} </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="bg-[#f7f7f7] p-3 rounded-md mb-3">
                    <div
                        class="flex justify-between items-center text-sm mb-3"
                    >
                        <span class="font-medium text-xs"
                            >{% trans "Ticket ID" %}</span
                        >
                        <span class="font-medium" name="ticketId" id="{{ticket.id}}">{{ticket.ticket_type.prefix}}{{ ticket.id|stringformat:"03d" }}</span>
                    </div>
                    <div
                        class="flex justify-between items-center text-sm mb-3"
                    >
                        <span class="font-medium text-xs">{% trans "Owner" %}</span>
                        <span class="font-medium" >{{ticket.employee_id}}</span>
                    </div>
                    <div
                        class="flex justify-between items-center text-sm mb-3"
                    >
                        <span class="font-medium text-xs">{% trans "Created" %}</span>
                        <span class="font-medium dateformat_changer">{{ticket.created_date}}</span>
                    </div>
                    <div
                        class="flex justify-between items-center text-sm mb-3"
                    >
                        <span class="font-medium text-xs"
                            >{% trans "Priority" %}</span
                        >
                        {% if perms.helpdesk.change_ticket or request.user.employee_get|is_department_manager:ticket or request.user.employee_get in ticket.assigned_to.all or request.user.employee_get == ticket.employee_id %}
                            <form hx-swap="none" hx-post="{% url 'update-priority' ticket.id %}" method="post">
                                {% csrf_token %}
                                <div class="d-flex">
                                    <div class="oh-rate"
                                        onclick="event.stopPropagation();$(this).parents().closest('form').find('button').click()">
                                        {% for i in "321" %}
                                            <input type="radio" id="star{{i}}{{ticket.id}}" name="rating" class="rating-radio" value="{{i}}" {% if rating == i %}checked{% endif %} />
                                            <label for="star{{i}}{{ticket.id}}"
                                                title="
                                                    {% if i == '1' %}{% trans 'Low' %}
                                                    {% elif i == '2' %}{% trans 'Medium' %}
                                                    {% else %}{% trans 'High' %}
                                                    {% endif %}
                                                "
                                            >
                                            </label>
                                        {% endfor %}
                                    </div>
                                    <button type="submit" hidden="true" onclick="event.stopPropagation()"></button>
                                    <span id="rating-radio-error"></span>
                                </div>
                            </form>
                        {% else %}
                            <ul class="flex gap-1 text-xs">
                                {% for i in "123" %}
                                    <li>
                                        <i
                                            class="fa-solid fa-star {% if rating >= i %}text-[#FFA800] {% else %} text-[#dfdfdf]{% endif %}"
                                        ></i>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                    <div
                        class="flex justify-between items-center text-sm mb-5"
                    >
                        <span class="font-medium text-xs"
                            >{% trans "Last Activity" %}</span
                        >
                        <span class="font-medium text-right"
                        >
                            {% with sorted_activity_list|last as last %}
                                {{ last.date }}
                            {% endwith %}
                        </span>
                    </div>

                    <h3 class="text-sm font-semibold mb-3">{% trans "Tags:" %}</h3>

                    <div class="w-full">
                        {% if perms.helpdesk.change_ticket or request.user.employee_get == ticket.employee_id or request.user.employee_get|is_department_manager:ticket %}
                            <div class="">
                                {{tag_form.tags}}
                            </div>
                        {% else %}
                            <span class="text-sm text-grey font-bold">
                                {% for tag in ticket.tags.all %}
                                    {{tag}},
                                {% empty %}
                                    {% trans "No tags assigned" %}
                                {% endfor %}
                            </span>
                        {% endif %}
                    </div>
                </div>

                <div class="flex items-center justify-between mb-2 px-3">
                    <h3 class="text-sm font-semibold">
                        {% trans "Responsibility" %}
                    </h3>
                    <p class="text-red-600 font-medium text-xs text-{{color}}">
                        {{remaining}}
                    </p>
                </div>
                <div class="bg-[#f7f7f7] p-3 rounded-md mb-3">
                    <div
                        class="flex justify-between items-center text-sm mb-3"
                    >
                        {% if perms.helpdesk.change_ticket or request.user.employee_get == ticket.employee_id %}
                            <p>{% trans "Forwarded to" %}</p>
                            <button
                                class="w-6 h-6 rounded-md bg-primary-600 flex items-center justify-center text-white text-xs transition duration-300 hover:bg-primary-700"
                                hx-get="{% url 'ticket-change-raised-on' ticket.id %}"
                                data-target="#objectDetailsModalW25"
                                data-toggle="oh-modal-toggle"
                                hx-target="#objectDetailsModalW25Target"
                                role="button"
                                title = "{% trans 'Edit' %}"
                            >
                                <i class="fa-solid fa-pen"></i>
                            </button>
                        {% endif %}
                    </div>
                    <h3 class="text-sm font-semibold mb-3">
                        {{ticket.get_raised_on_object}}
                    </h3>
                    <div
                        class="flex flex-wrap justify-between items-center text-sm"
                    >
                        <p>{% trans "Assigned to" %}</p>
                        <div class="flex gap-1">
                            <button
                                class="w-6 h-6 rounded-md bg-primary-600 flex items-center justify-center text-white text-xs transition duration-300 hover:bg-primary-700"
                                data-toggle="oh-modal-toggle"
                                data-target="#objectDetailsModal"
                                hx-get="{% url 'view-ticket-claim-request' ticket.id %}"
                                hx-target="#objectDetailsModalTarget"
                                title="{% trans " Claim Requests" %}"
                            >
                                <i class="fa-solid fa-eye"></i>
                            </button>
                            <button
                                class="w-6 h-6 rounded-md bg-primary-600 flex items-center justify-center text-white text-xs transition duration-300 hover:bg-primary-700"
                                hx-get="{% url 'ticket-change-assignees' ticket.id %}"
                                data-toggle="oh-modal-toggle"
                                data-target="#objectDetailsModalW25"
                                hx-target="#objectDetailsModalW25Target"
                                title="{% trans 'Edit' %}"
                            >
                                <i class="fa-solid fa-pen"></i>
                            </button>
                        </div>
                    </div>
                    <ul class="userlist">
                        {% with employee_list=ticket.assigned_to.all %}
                            {% for employee in employee_list|slice:":6" %}
                                <li>
                                    <span>
                                        <a href="{% url 'employee-view-individual' employee.id %}" title="{{employee.get_full_name}}">
                                            <img
                                                src="{{employee.get_avatar}}"
                                                alt=""
                                                class="w-6 h-6 rounded-full"
                                            />
                                        </a>
                                    </span>
                                </li>
                            {% endfor %}
                            {% if employee_list|length > 6 %}
                                <li>
                                    <span>+{{employee_list.count|add:"-6"}} </span>
                                </li>
                            {% endif %}
                        {% endwith %}
                    </ul>
                </div>

                <h3 class="text-sm font-semibold mb-2">{% trans "Documents" %}</h3>

                <div class="mb-3 w-full">
                    <label
                        for="fileUpload1"
                        class="flex items-center bg-white justify-center gap-2 px-4 py-2 border border-dark-50 rounded-md text-xs text-gray-700 cursor-pointer hover:bg-gray-100 transition duration-300"
                    >
                        <svg
                            class="w-4 h-4 text-primary-600"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M12 12V4m0 0l4 4m-4-4L8 8"
                            ></path>
                        </svg>
                        {% trans "Choose File" %}
                    </label>

                    <input
                        id="fileUpload1"
                        type="file"
                        class="hidden"
                        name="file"
                        hx-trigger = "change"
                        hx-target="#fileNamePreview"
                        hx-select="#fileNamePreview"
                        hx-post="{% url 'ticket-file-upload' ticket.id %}"
                        hx-encoding="multipart/form-data"
                        multiple
                    />

                    <div id="fileNamePreview" class="flex gap-1 mt-3 text-sm text-gray-600 flex-wrap">
                        {% if attachments %}
                            {% for attachment in attachments %}
                                {% with extension=attachment.file.name|lower|slice:"-4:" %}
                                    <div class="relative fileItem">
                                        <a class="me-2"
                                            data-toggle="oh-modal-toggle"
                                            data-target="#viewFileModal"
                                            hx-target="#viewFile"
                                            hx-get="{% url 'view-ticket-document' attachment.id %}"
                                        >

                                            <div class="oh-helpdesk__icon">
                                                <span
                                                    title="{{ attachment }}"
                                                    class="oh-file-icon
                                                    {% if extension == '.pdf' %} oh-file-icon--pdf
                                                    {% elif extension in '.jpg .jpeg .png .gif .svg' %} oh-file-icon--image
                                                    {% elif extension in '.mp3 .wav .ogg' %} oh-file-icon--audio
                                                    {% elif extension in '.doc .docx' %} oh-file-icon--word
                                                    {% elif extension in '.xls .xlsx' %} oh-file-icon--excel
                                                    {% elif extension in '.ppt .pptx' %} oh-file-icon--powerpoint
                                                    {% elif extension in '.html' %} oh-file-icon--html
                                                    {% else %} oh-file-icon--default
                                                    {% endif %}"
                                                >
                                                </span>
                                            </div>

                                        </a>
                                        <span class="absolute"
                                            style="top: -6px; right: 0px; color: red; font-size: 16px; cursor: pointer;"
                                            title="Delete attachment"
                                            hx-delete="{% url 'delete-ticket-document' attachment.id %}"
                                            hx-confirm="Are you sure you want to delete this file?"
                                            hx-swap="delete" hx-target="closest .fileItem"
                                            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                            hx-on-htmx-after-request="$('#reloadMessagesButton').click();"
                                        >
                                            &times;
                                        </span>
                                    </div>
                                {% endwith %}
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: 6/12 -->
    <div class="col-span-12 lg:col-span-9">
        <div
            class="bg-white rounded-md shadow-card p-3"
        >
            <div class="flex justify-end">
                {% if perms.helpdesk.change_ticket or request.user.employee_get|is_department_manager:ticket %}
                    <button
                        class="p-3 w-100 h-6 mb-2 rounded-md bg-primary-600 flex items-center justify-center text-white text-xs transition duration-300 hover:bg-primary-700"
                        title="{% trans 'Edit Ticket' %}"
                        data-toggle="oh-modal-toggle"
                        data-target="#objectCreateModal"
                        hx-get="{% url 'ticket-update' ticket.id %}"
                        hx-target="#objectCreateModalTarget"
                    >
                    <i class="fa-solid fa-pen"></i>
                    <span class="ms-2 text-sm font-semibold">{% trans "Edit" %}</span>
                    </button>
                {% endif %}
            </div>
            <div
                class="h-[80%] lg:h-[calc(100%_-_55px)]"
            >
                <div
                    class="bg-[#fff6e8] p-3 rounded-md border border-[#ffe2b6] mb-5"
                >
                    <div class="flex items-center justify-between mb-3">
                        <div
                            class="flex gap-3 items-center font-semibold text-sm"
                        >
                            <img
                                src="{{ticket.employee_id.get_avatar}}"
                                alt=""
                                width="30"
                            /><span>{{ticket.employee_id}}</span>
                        </div>
                        <p class="text-sm text-[#ff8c00] font-semibold">
                            <span class="dateformat_changer">{{ ticket.created_date}}</span>
                        </p>
                    </div>
                    <p class="text-sm text-[#333]">
                        {{ticket.description|safe}}
                    </p>
                </div>
                <div class=" h-[calc(100vh_-_365px)] overflow-hidden overflow-y-auto p-5" id="ticketContainer">
                {% for item in sorted_activity_list %}
                    {% if item.type == 'comment' %}
                        {% if item.comment.employee_id == ticket.employee_id %}
                            {% comment %} <div class="w-full flex justify-end mb-3">
                                <div
                                    class="bg-[#26bf941a] p-5 rounded-2xl max-w-[90%] md:w-[60%] mb-3 md:mb-1"
                                >
                                    <div
                                        class="flex flex-wrap items-center justify-between mb-3"
                                    >
                                        <div
                                            class="flex gap-3 items-center font-semibold text-sm"
                                        >
                                            <img
                                                src="{{item.comment.employee_id.get_avatar}}"
                                                alt="{{item.comment.employee_id}}"
                                                width="30"
                                            /><span>{{item.comment.employee_id.get_full_name}}</span>
                                        </div>
                                        <p class="text-sm font-semibold">
                                            <span class="dateformat_changer">{{ item.comment.date|date}}</span>
                                            <span class="timeformat_changer">{{ item.comment.date|time}}</span>
                                        </p>
                                    </div>
                                    <span class="text-sm text-[#333]">
                                        {{item.comment.comment|safe}}
                                    </span>
                                    <div class="oh-btn-group" style="border:none">
                                        {% if request.user.employee_get|is_department_manager:ticket or perms.helpdesk.change_comment or request.user.employee_get == item.comment.employee_id %}
                                            <a class="oh-btn p-3 edit_comment" title="{% trans 'Edit' %}">
                                                <ion-icon name="pencil-outline"></ion-icon>
                                            </a>
                                        {% endif %}
                                        {% if perms.helpdesk.delete_comment %}
                                            <a href="{% url "comment-delete" item.comment.id %}" type="button"
                                                title="{% trans 'Delete' %}" class="oh-btn p-3 text-danger">
                                                <ion-icon name="trash-outline"></ion-icon>
                                            </a>
                                        {% endif %}
                                    </div>

                                    <div class="w-[80%] overflow-x-auto flex mt-3">
                                        {% if item.comment.comment_attachment.all %}
                                            {% for attachment in item.comment.comment_attachment.all %}
                                                {% with extension=attachment.file.name|lower|slice:"-4:" %}
                                                    <a class="me-2"
                                                        data-toggle="oh-modal-toggle"
                                                        data-target="#viewFileModal"
                                                        hx-target="#viewFile"
                                                        hx-get="{% url 'view-ticket-document' attachment.id %}"
                                                    >
                                                        <div class="oh-helpdesk__icon bg-[#d944bb1a]">
                                                            <span class="oh-file-icon
                                                                {% if extension == '.pdf' %} oh-file-icon--pdf
                                                                {% elif extension in '.jpg .jpeg .png .gif .svg' %} oh-file-icon--image
                                                                {% elif extension in '.mp3 .wav .ogg' %} oh-file-icon--audio
                                                                {% elif extension in '.doc .docx' %} oh-file-icon--word
                                                                {% elif extension in '.xls .xlsx' %} oh-file-icon--excel
                                                                {% elif extension in '.ppt .pptx' %} oh-file-icon--powerpoint
                                                                {% elif extension in '.html' %} oh-file-icon--html
                                                                {% else %} oh-file-icon--default
                                                                {% endif %}"
                                                                title="{{ attachment }}"
                                                            >
                                                            </span>
                                                        </div>
                                                    </a>
                                                {% endwith %}
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div> {% endcomment %}
                            <div class="w-full flex justify-end mb-3">
                                <div
                                    class="bg-[#26bf941a] p-5 rounded-2xl max-w-[90%] md:w-[60%] mb-3 md:mb-1"
                                >
                        {% else %}
                            <div class="w-full flex justify-start mb-3">
                                <div
                                    class="bg-[#d944bb1a] p-5 rounded-2xl max-w-[90%] md:w-[60%] mb-3 md:mb-1"
                                >
                        {% endif %}
                                    <div
                                        class="flex flex-wrap items-center justify-between mb-3"
                                    >
                                        <div
                                            class="flex gap-3 items-center font-semibold text-sm"
                                        >
                                            <img
                                                src="{{item.comment.employee_id.get_avatar}}"
                                                alt="{{item.comment.employee_id}}"
                                                width="30"
                                                class="rounded-full"
                                            /><span>{{item.comment.employee_id.get_full_name}}</span>
                                        </div>
                                        <p class="text-sm font-semibold">
                                            <span class="dateformat_changer">{{ item.comment.date|date}}</span>
                                            <span class="timeformat_changer">{{ item.comment.date|time}}</span>
                                        </p>
                                    </div>
                                    <div class="comment_container flex justify-between items-center">
                                        <textarea class="w-full comment_input"
                                            data-comment-id="{{item.comment.id}}">{{item.comment.comment}}</textarea>
                                        <span class="text-sm text-[#333] comment_text">
                                            {{item.comment.comment|safe}}
                                        </span>
                                        <div class="oh-btn-group" style="border:none">
                                            {% if request.user.employee_get|is_department_manager:ticket or perms.helpdesk.change_comment or request.user.employee_get == item.comment.employee_id %}
                                                <a class="oh-btn p-3 edit_comment" title="{% trans 'Edit' %}">
                                                    <ion-icon name="pencil-outline"></ion-icon>
                                                </a>
                                            {% endif %}
                                            {% if perms.helpdesk.delete_comment %}
                                                <a href="{% url "comment-delete" item.comment.id %}" type="button"
                                                    title="{% trans 'Delete' %}" class="oh-btn p-3 text-danger">
                                                    <ion-icon name="trash-outline"></ion-icon>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="w-[80%] overflow-x-auto flex ">
                                        {% if item.comment.comment_attachment.all %}
                                            {% for attachment in item.comment.comment_attachment.all %}
                                                {% with extension=attachment.file.name|lower|slice:"-4:" %}
                                                    <a class="me-2"
                                                        data-toggle="oh-modal-toggle"
                                                        data-target="#viewFileModal"
                                                        hx-target="#viewFile"
                                                        hx-get="{% url 'view-ticket-document' attachment.id %}"
                                                    >
                                                        <div class="oh-helpdesk__icon bg-[#d944bb1a]">
                                                            <span class="oh-file-icon
                                                                {% if extension == '.pdf' %} oh-file-icon--pdf
                                                                {% elif extension in '.jpg .jpeg .png .gif .svg' %} oh-file-icon--image
                                                                {% elif extension in '.mp3 .wav .ogg' %} oh-file-icon--audio
                                                                {% elif extension in '.doc .docx' %} oh-file-icon--word
                                                                {% elif extension in '.xls .xlsx' %} oh-file-icon--excel
                                                                {% elif extension in '.ppt .pptx' %} oh-file-icon--powerpoint
                                                                {% elif extension in '.html' %} oh-file-icon--html
                                                                {% else %} oh-file-icon--default
                                                                {% endif %}"
                                                                title="{{ attachment }}"
                                                            >
                                                            </span>
                                                        </div>
                                                    </a>
                                                {% endwith %}
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% comment %} {% endif %} {% endcomment %}
                    {% elif item.type == 'history' %}
                        {% if item.history.type == 'Ticket created' %}
                            <p class="text-sm text-[#0E79DC] mb-2">
                                <strong><i>{{item.history.updated_by}}</i></strong> {% trans "Created the ticket " %}
                            </p>
                        {% elif item.history.changes.0.is_fk == True %}
                        <div
                            class="flex flex-wrap items-center justify-between mb-3"
                        >
                            <p class="text-sm">
                                {{item.history.updated_by}} {% trans "changed the ticket " %}{{item.history.changes.0.field|safe}} {% trans " from" %}
                                <strong>{{item.history.pair.0|fk_history:item.history.changes.0|safe}}</strong> {% trans "to" %}
                                <strong>{{item.history.pair.1|fk_history:item.history.changes.0|safe}}</strong>
                            </p>
                            <p class="text-sm text-[#E54F38] font-semibold">
                                <span class="dateformat_changer">{{ item.history.pair.0.history_date|date}}</span>
                                <span class="timeformat_changer">{{ item.history.pair.0.history_date|time}}</span>
                            </p>
                        </div>
                        {% else %}
                        <div
                            class="flex flex-wrap items-center justify-between mb-3"
                        >
                            <p class="text-sm">
                                <i>{{item.history.updated_by}}</i> {% trans "changed the ticket " %}
                                {{item.history.changes.0.field|safe}}
                                {% trans " from" %}
                                <strong>{{item.history.changes.0.old|safe}}</strong>
                                {% trans "to" %}
                                <strong>{{item.history.changes.0.new|safe}}</strong>
                            </p>
                            <p class="text-sm text-[#E54F38] font-semibold">
                                <span class="dateformat_changer">{{ item.history.pair.0.history_date|date}}</span>
                                <span class="timeformat_changer">{{ item.history.pair.0.history_date|time}}</span>
                            </p>
                        </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                </div>
            </div>
            {% if perms.helpdesk.add_comment or request.user.employee_get == ticket.employee_id or request.user.employee_get in ticket.assigned_to.all %}
                <div
                    class="sticky bottom-0 h-[20%] lg:h-[55px] flex items-end"
                >
                    <div class="relative w-full">
                        <form class="comment-form" name="comment-form" action="{% url 'comment-create' ticket.id %}" method="POST"
                            enctype="multipart/form-data" class="oh-chat oh-chat__input-wrapper">
                            {% csrf_token %}
                            <input name="file" type="file" id="fileUpload" class="hidden" multiple />
                            <label aria-role="button" for="fileUpload" aria-label="Attach Files"
                                class="oh-btn oh-btn--chat oh-btn--chat-attachments absolute left-1 top-0 bottom-0 m-auto h-9">
                                <!-- The file count badge -->
                                <span id="fileCount"
                                    class="absolute left-[-10px] top-[-6px] bg-danger text-white text-xs rounded-full px-2 py-1"
                                    style="display: none;"
                                >
                                </span>
                            </label>
                            <input
                                class="w-full pl-[40px] p-3 rounded-full text-sm bg-[#f1f1f1] placeholder:text-xs focus:outline-none"
                                placeholder="Write your message here..."
                                name="comment"
                                type="text"
                            />
                            <button
                                type="submit"
                                onclick="validateComment(event)"
                                class="absolute right-1 top-0 bottom-0 m-auto h-9 flex justify-center items-center cursor-pointer bg-[white] text-primary-600 rounded-full w-9 hover:bg-primary-200 transition duration-300"
                            >
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="oh-modal" id="viewFileModal" role="dialog" aria-labelledby="viewFileModal" aria-hidden="true">
    <div class="oh-modal__dialog custom-dialog">
        <div class="oh-modal__dialog-header">
            <span class="oh-modal__dialog-title" id="viewFileModalLabel">{% trans "View File" %}</span>
            <button class="oh-modal__close" aria-label="Close" onclick="$(this).closest('.oh-modal--show').removeClass('oh-modal--show')" >
                <ion-icon name="close-outline" role="img" class="md hydrated" aria-label="close outline"></ion-icon>
            </button>
        </div>
        <div class="oh-modal__dialog-body" id="viewFile"></div>
    </div>
</div>

<script>

    $('#fileUpload').on('change', function () {
        const fileCount = this.files.length;
        const $countSpan = $('#fileCount');

        if (fileCount > 0) {
            $countSpan.text(fileCount).css('display', 'inline-block');
        } else {
            $countSpan.css('display', 'none');
        }
    });

    function showTag() {
        var title = $('#id_title').val()
        var color = $("#id_color").val()
        var is_active = $("#id_is_active").val()
        $.ajax({
            type: "post",
            url: `/helpdesk/ticket-create-tag`,
            data: {
                csrfmiddlewaretoken: getCookie("csrftoken"),
                "title": title,
                "color": color,
                "is_active": is_active,
            },
            success: function (response) {
                if (response.errors === "no_error") {
                    var newOption = $('<option selected></option>').val(response.tag_id).text(response.title)
                    $("#editModal").removeClass("oh-modal--show");
                    $("#id_tags option[value='create_new_tag']").before(newOption);
                    $("#id_tags option[value='create_new_tag']").prop('selected', false)
                    updateTag()
                }
            }
        });
    }

    function updateStatus(elem) {
        var status = $(elem).val()
        var ticketID = $(elem).data('ticket');
        $.ajax({
            type: "post",
            url: `/helpdesk/change-ticket-status/${ticketID}/`,
            data: {
                csrfmiddlewaretoken: getCookie("csrftoken"),
                "status": status,
            },
            success: function (response) {
                var duration = 0;
                if (response.errors != "noChange") {
                    $("#ohMessages").append(`
                        <div class="oh-alert-container">
                            <div class="oh-alert oh-alert--animated oh-alert--${response.type}">
                            ${response.message}
                            </div>
                        </div>`
                    );
                    duration = 1500;
                    $('#ticketContainer').append(
                        `<div class="flex flex-wrap items-center justify-between mb-3">
                            <p class="text-sm">
                                <i>${response.user}</i> changed the ticket Status from
                                <strong>${response.pre_status}</strong> to <strong>${response.cur_status}</strong>
                            </p>
                            <p class="text-sm text-[#E54F38] font-semibold">${response.time}</p>
                        </div>`
                    )
                }
            },
        });
    }

    function validateComment(event) {
        var comment = $(".comment-form [name='comment']").val().trim();
        var fileInput = $(".comment-form [name='file']")[0];
        var filesSelected = fileInput.files && fileInput.files.length > 0;

        if (comment === '' && !filesSelected) {
            event.preventDefault();
        }
    }

    function updateTag(event) {
        var ticketId = $("[name='ticketId']").attr('id');
        var selectedValues = $("#id_tags option:selected").map(function () {
            return $(this).val();
        }).get();
        // Check if 'create_new_tag' exists in the list
        if (selectedValues.includes('create_new_tag')) {
            $("#editModal").addClass("oh-modal--show");
        } else {
            // ajax function for save the tag to ticket
            $.ajax({
                type: 'GET',
                url: '/helpdesk/ticket-change-tag',
                data: { "selectedValues": selectedValues, 'ticketId': ticketId },
                success: function (response) {
                    var duration = 0;
                    if (response.errors != "noChange") {
                        $("#ohMessages").append(`
                            <div class="oh-alert-container">
                                <div class="oh-alert oh-alert--animated oh-alert--${response.type}">
                                ${response.message}
                                </div>
                            </div>`
                        );
                        duration = 1500;
                    }
                },
            })
        }
    }

    $('#fileUpload1').on('change', function () {
        var files = this.files;
        var $fileNameList = $('#fileNamePreview');
        $fileNameList.empty();

        if (files.length > 0) {
            $.each(files, function (index, file) {
                $fileNameList.append(`<li>${file.name}</li>`);
            });
            $fileNameList.removeClass('hidden');
        } else {
            $fileNameList.addClass('hidden');
        }
    });

    $(document).ready(function () {
        $("#fileUpload").attr('multiple', '');
        $('.comment_container textarea').hide();

        $(".edit_comment").on("click", function () {
            let container = $(this).closest('.comment_container')
            let text = $(container).find('.comment_text')
            let input = $(container).find('textarea')
            $(text).hide()
            $(input).show()
            $(input).focus()
            var length = input.val().length;
            input[0].setSelectionRange(length, length);

        })

        $(".comment_input").on("keydown", function (event) {
            if (event.keyCode === 13 && !event.shiftKey) {
                event.preventDefault();
                $(this).blur();
            }
        });

        $(".comment_input").on('focusout', function () {
            let newComment = $(this).val()
            let commentId = $(this).data("comment-id")

            $.ajax({
                type: "post",
                url: "{% url 'comment-edit' %}",
                data: {
                    csrfmiddlewaretoken: getCookie("csrftoken"),
                    "new_comment": newComment,
                    "comment_id": commentId,
                },
                success: function (response) {
                    window.location.reload()
                },
            })
        })

        setTimeout(function () {
            var container = $('#ticketContainer');
            if (container.length > 0) {
                container.animate(
                    { scrollTop: container[0].scrollHeight },
                    500 // duration in milliseconds (e.g., 500ms = half a second)
                );
            }
        }, 100);
    })
</script>

{% endblock %}
