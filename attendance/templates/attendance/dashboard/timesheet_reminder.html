{% load i18n %}



{# Dedicated Reminder section with employee + manager views #}
{% if employee_reminders or manager_reminders %}
  <section class="ts-section" role="region" aria-label="{% trans 'Timesheet Reminders' %}">
    <div class="ts-card">
      {% if employee_reminders %}
      <div class="ts-block">
        <div class="ts-block__head">
          <span class="ts-block__title">{% trans "Your Timesheet" %}</span>
        </div>
        <ul class="ts-list">
          {% for rem in employee_reminders %}
            <li class="ts-list__item">
              <div class="ts-list__content">
                <p class="ts-list__text">{{ rem.message }}</p>
                {% if rem.mismatch %}
                <span class="ts-list__meta">{% trans "Logged" %} {{rem.logged_hm}} / {% trans "Worked" %} {{rem.worked_hm}}</span>
                {% endif %}
              </div>
              <div class="ts-list__actions">
                <a href="{{ timesheet_url }}" class="oh-btn oh-btn--primary">{% trans "Complete Now" %}</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      {% if manager_reminders %}
      <div class="ts-block">
        <div class="ts-block__head">
          <span class="ts-block__title">{% trans "Team Timesheet Issues" %} ({{ manager_reminders|length }})</span>
          <div class="ts-block__controls">
            <label for="ts-team-toggle" class="sr-only">{% trans "Toggle team issues" %}</label>
            <select id="ts-team-toggle" class="ts-select">
              <option value="show">{% trans "Show" %}</option>
              <option value="hide" selected>{% trans "Hide" %}</option>
            </select>
          </div>
        </div>
        <div id="ts-team-container" hidden>
          <ul class="ts-list">
            {% for rem in manager_reminders %}
              <li class="ts-list__item">
                <div class="ts-list__content">
                  <p class="ts-list__text">{{ rem.message }}</p>
                  {% if rem.mismatch %}
                  <span class="ts-list__meta">{% trans "Logged" %} {{rem.logged_hm}} / {% trans "Worked" %} {{rem.worked_hm}}</span>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}

    </div>
  </section>
{% endif %}

{# Modal: hard lock with backdrop, built and appended to body #}

{% if employee_reminders or manager_reminders %}

  <template id="ts-modal-template">
    <div class="ts-modal" id="timesheetReminderModal" role="dialog" aria-modal="true" aria-labelledby="ts-modal-title">
      <div class="ts-modal__backdrop" id="ts-backdrop"></div>
      <div class="ts-modal__dialog">
        <button class="ts-modal__close" aria-label="Close" id="ts-modal-close">&times;</button>
        <div class="ts-modal__header">
          <span class="ts-modal__title" id="ts-modal-title">{% trans "Reminder: Action Required" %}</span>
        </div>
        <div class="ts-modal__body ts-modal__body--center">
          <div class="ts-modal__icon" aria-hidden="true">

            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
              <path d="M12 7v5l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <p class="ts-modal__msg">{% if employee_reminders %}{{ employee_reminders.0.message }}{% else %}{{ manager_reminders.0.message }}{% endif %}</p>

          <a href="{{ timesheet_url }}" class="oh-btn oh-btn--primary" id="ts-modal-complete">{% trans "Complete Now" %}</a>
        </div>
      </div>
    </div>
  </template>

  <style>

    /* Section card */
    .ts-section { margin: 8px 0 14px; }
    .ts-card { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 10px 4px; }
    .ts-block + .ts-block { border-top: 1px dashed #e5e7eb; margin-top: 8px; padding-top: 8px; }
    .ts-block__head { display:flex; align-items:center; justify-content:space-between; margin-bottom: 6px; }
    .ts-block__title { font-weight: 600; color: #0f172a; }
    .ts-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px; }
    .ts-list__item { display:flex; align-items:center; justify-content:space-between; gap: 12px; background:#f8fafc; border:1px solid #e5e7eb; border-radius: 8px; padding: 10px 12px; }
    .ts-list__content { display:flex; flex-direction:column; }
    .ts-list__text { margin:0; color:#111827; }
    .ts-list__meta { margin-top:2px; color:#475569; font-size:.9rem; }
    .ts-list__actions { flex-shrink:0; }
    .ts-block__controls { display:flex; align-items:center; gap:6px; }
    .ts-select { padding: 4px 8px; border:1px solid #e5e7eb; border-radius: 6px; background:#fff; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }


    /* Modal */
    .ts-modal__backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(3px); z-index: 2000; }
    .ts-modal__dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 440px; max-width: 92vw; background: #fff; border-radius: 16px; padding: 18px 18px 22px; z-index: 2001; box-shadow: 0 20px 60px rgba(0,0,0,0.25); animation: ts-fade-in 180ms ease-out; }
    .ts-modal__header { display: flex; align-items: center; justify-content: center; margin-bottom: 6px; }
    .ts-modal__title { font-weight: 600; font-size: 1.05rem; }
    .ts-modal__close { background: none; border: none; font-size: 22px; cursor: pointer; color: #374151; position: absolute; right: 8px; top: 8px; }
    .ts-modal__close:hover { color: #111827; }
    .ts-modal__body--center { display:flex; flex-direction:column; align-items:center; text-align:center; gap: 10px; }

    .ts-modal__icon { color: #dc2626; }
    .ts-modal__icon svg { display:block; width:64px; height:64px; }

    .ts-modal__msg { margin: 0 0 4px; color: #111827; font-size: 1rem; }
    @keyframes ts-fade-in { from { opacity:0; transform: translate(-50%,-46%);} to { opacity:1; transform: translate(-50%,-50%);} }
    .ts-body-lock { overflow: hidden !important; }
  </style>

  <script>
    (function(){
      const shownKey = 'timesheetReminderShown';

      function showModalOnce(){
        if (sessionStorage.getItem(shownKey) === '1') return; // already shown this session
        if (document.getElementById('timesheetReminderModal')) return; // already present
        const tpl = document.getElementById('ts-modal-template');
        if (!tpl) return;
        const node = tpl.content ? tpl.content.cloneNode(true) : null;
        if (!node) return;
        document.body.appendChild(node);
        document.body.classList.add('ts-body-lock');

        const modal = document.getElementById('timesheetReminderModal');
        const closeBtn = document.getElementById('ts-modal-close');
        const completeBtn = document.getElementById('ts-modal-complete');
        const backdrop = document.getElementById('ts-backdrop');

        function close(){
          modal?.remove();
          document.body.classList.remove('ts-body-lock');
          sessionStorage.setItem(shownKey, '1');
        }

        closeBtn?.addEventListener('click', close);
        backdrop?.addEventListener('click', close);
        completeBtn?.addEventListener('click', ()=>{
          sessionStorage.setItem(shownKey, '1');
          document.body.classList.remove('ts-body-lock');
        });
      }


      function initTeamToggle(){
        const sel = document.getElementById('ts-team-toggle');
        const cont = document.getElementById('ts-team-container');
        if (!sel || !cont) return;
        const storeKey = 'tsTeamIssuesToggle';
        const saved = sessionStorage.getItem(storeKey) || 'hide';
        sel.value = saved;
        if (saved === 'show') cont.hidden = false; else cont.hidden = true;
        sel.addEventListener('change', function(){
          const v = this.value === 'show' ? 'show' : 'hide';
          sessionStorage.setItem(storeKey, v);
          cont.hidden = v !== 'show';
        });
      }

      try { showModalOnce(); initTeamToggle(); } catch(e) { /* no-op */ }

    })();
  </script>
{% endif %}

