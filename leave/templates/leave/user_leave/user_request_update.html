{% load i18n %}{% load horillafilters %} {% if messages %}{% load widget_tweaks %}
<div class="oh-wrapper">
    {% for message in messages %}
    <div class="oh-alert-container">
        <div class="oh-alert oh-alert--animated {{message.tags}}">
            {{ message }}
        </div>
    </div>
    {% endfor %}
    <script>
        setTimeout(function () {
            $(".oh-modal__close").click();
        }, 1000);
    </script>
</div>
{% endif %}
<div class="oh-modal__dialog-header">
    <span class="oh-modal__dialog-title"
        >{% trans "Leave Request Update" %}</span
    >
    <button
        class="oh-modal__close"
        aria-label="Close"
        {%
        if
        messages
        %}
        hx-get="{% url 'user-request-filter' %}?{{pd}}"
        hx-target="#userRequest"
        {%
        endif
        %}
    >
        <ion-icon name="close-outline"></ion-icon>
    </button>
</div>
<div class="oh-modal__dialog-body">
    <form
        hx-post="{% url 'user-request-update' id %}?{{pd}}"
        hx-encoding="multipart/form-data"
        hx-target="#objectUpdateModalTarget"
        id="userLeaveForm"
    >
{% if form.non_field_errors %}
   <div class="col-12">{{ form.non_field_errors }}</div>
{% endif %}
    <div class="row">
        {% for field in form.visible_fields %}
            {% if field.name != "description" %}
                <div class="col-12 col-md-6">
                    <div class="form-group oh-form-group">
                        <label class="oh-label {% if field.field.required %}required-star{% endif %}">
                            {{ field.label }}
                        </label>

                        {{ field|add_class:"form-control oh-input w-100" }}

                        {% if field.errors %}
                            <div class="text-danger text-sm mt-1">
                                {{ field.errors }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <div class="row">
        <div class="col-12">
            <div class="form-group oh-form-group">
                <label class="oh-label required-star">
                    {{ form.description.label }}
                </label>

                {{ form.description|add_class:"form-control oh-input w-100" }}

                <small class="text-muted d-block mt-1" id="descriptionCounter">
                    0 / 255 characters
                </small>

                {% if form.description.errors %}
                    <div class="text-danger text-sm mt-1">
                        {{ form.description.errors }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% for field in form.hidden_fields %}
        {{ field }}
    {% endfor %}

    <div class="d-flex flex-row-reverse mt-3">
        <button type="submit"
                class="oh-btn oh-btn--secondary pl-4 pr-5 oh-btn--w-100-resp">
            {% trans "Save" %}
        </button>
    </div>

</form>
</div>

{#{% if "recruitment"|app_installed %}#}
{#    <script>#}
{#        $("#userLeaveForm [type=submit]").hide();#}
{#        var button = `#}
{#        <div class="oh-modal__dialog-footer p-0 mt-3">#}
{#        <button id="buttonID" class="oh-btn oh-btn--secondary oh-btn--shadow">#}
{#            Save#}
{#        </button>#}
{#        </div>#}
{#        `;#}
{#        $("#userLeaveForm .row").after(button);#}
{##}
{#        $(document).ready(function () {#}
{#            $("#buttonID").on("click", function () {#}
{#                event.preventDefault();#}
{#                event.stopPropagation();#}
{#                var startDate = $("#userLeaveForm [name = start_date]").val();#}
{#                var endDate = $("#userLeaveForm [name = end_date]").val();#}
{#                var employee = "{{request.user.employee_get.id}}";#}
{##}
{#                $.ajax({#}
{#                    type: "GET",#}
{#                    url: "{% url 'check-interview-conflicts' %}",#}
{#                    data: {#}
{#                        start_date: startDate,#}
{#                        end_date: endDate,#}
{#                        employee_id: employee,#}
{#                    },#}
{#                    success: function (response) {#}
{#                        var interviews = response.interviews;#}
{##}
{#                        title = "Leave Request Alert.";#}
{#                        var content = `<div>#}
{#                <p>{{request.user.employee_get}} has interview in the requested date.</p>#}
{#                <ol style="margin-left:5%">`;#}
{#                        interviews.forEach(function (interview, index) {#}
{#                            content += `<li style="text-align:left; font-size:14px">${interview}</li>`;#}
{#                        });#}
{#                        content += `</ol>#}
{#                <p style="font-weight:700">Are you sure you want to proceed with the request?</p>#}
{#            </div>`;#}
{##}
{#                        if (interviews.length != 0) {#}
{#                            Swal.fire({#}
{#                                title: title,#}
{#                                icon: "info",#}
{#                                html: content,#}
{#                                showCancelButton: true,#}
{#                                confirmButtonColor: "#008000",#}
{#                                cancelButtonColor: "#d33",#}
{#                                confirmButtonText: "Confirm",#}
{#                            }).then(function (result) {#}
{#                                if (result.isConfirmed) {#}
{#                                    $("#userLeaveForm [type=submit]").click();#}
{#                                }#}
{#                            });#}
{#                        } else {#}
{#                            $("#userLeaveForm [type=submit]").click();#}
{#                        }#}
{#                    },#}
{#                });#}
{#            });#}
{#        });#}
{#    </script>#}
{#{% endif %}#}
<script>
document.body.addEventListener("htmx:afterSwap", function (event) {
    if (!event.target.closest("#objectCreateModalTarget")) return;

    const textarea = document.querySelector("#id_description");
    const counter = document.querySelector("#descriptionCounter");

    if (!textarea || !counter) return;

    const maxLength = 255;

    function updateCounter() {
        const length = textarea.value.length;
        counter.textContent = `${length} / ${maxLength} characters`;

        if (length >= maxLength) {
            counter.style.color = "red";
        } else if (length >= maxLength - 20) {
            counter.style.color = "orange";
        } else {
            counter.style.color = "#6b7280";
        }
    }

    textarea.removeEventListener("input", updateCounter);
    textarea.addEventListener("input", updateCounter);
    updateCounter();
});
</script>