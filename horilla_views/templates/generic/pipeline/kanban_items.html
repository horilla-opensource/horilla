{% load static i18n horillafilters recruitmentfilters generic_template_filters %}
{% for instance in group.page_obj %}
    <div class="task-card"
        data-instance-id = "{{instance.id}}"
        data-group = "{{group.label.id}}"
        {{view.kanban_attrs|format:instance|safe}}
    >

        <div class="p-[20px] rounded-[5px] text-sm relative bg-white mb-2">
            {% if actions or view.action_method %}
            <div
                x-data="{ open: false }"
                class="absolute inline-block dropdown-wrapper right-5 top-5 w-3"
                @click.outside="open = false"
                title="{% trans 'Actions' %}"
                onclick="event.stopPropagation()"
            >
                <a class="cursor-pointer dropdown-toggle" @click="open = !open">
                    <i class="fa-solid fa-ellipsis-vertical text-black"></i>
                </a>

                <div
                    x-show="open"
                    x-transition
                    style="cursor:pointer;"
                    class="dropdown-menu absolute right-0 bg-[#f7f7f7] rounded-lg shadow-card py-2 z-50 min-w-[170px]"
                >
                    <ul class="text-xs">
                        {% if view.action_method %}
                            {{ instance|getattribute:view.action_method|safe }}
                        {% else %}
                            {% for action in actions %}
                                {% if action.accessibility|accessibility:instance %}
                                    <li class="p-1">
                                        <p
                                            class="w-full text-left px-3 py-1 hover:text-primary-600 font-semibold"
                                        >
                                            <a {{action.attrs|format:instance|safe}}>{{instance|getattribute:action.action|default:action.action}}</a>
                                        </p>
                                    </li>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <div
                class="flex items-center gap-5 mb-3 pb-1 border-b border-b-[#565e6c13]"
            >
                {% if details.image_src %}
                    <div class="relative flex items-center w-max">
                        <img
                            src="{{details.image_src|format:instance|selected_format:request.user.employee_get.employee_work_info.company_id|safe}}"
                            class="w-11 h-11 rounded-full"
                            alt="Username"
                        />
                    </div>
                {% endif %}
                {% if details.title %}
                <div>
                    <span
                        class="block"
                        data-type="label"
                    >
                        <h5 class="font-bold text-base">
                            {{details.title|format:instance}}
                        </h5>
                        <input name="group_id" id="" hidden />
                    </span>
                </div>
                {% endif %}
            </div>

            {% for key, value in details.items %}
                {% if key != "image_src" and key != "title" %}
                <div class="flex gap-2 items-center relative mb-2">
                    <span class="font-medium text-xs text-[#565E6C]"
                        >{{key|title}} : </span
                    >
                    <p class="text-xs font-semibold flex items-center gap-2">
                        <span>{{value|format:instance|selected_format:request.user.employee_get.employee_work_info.company_id|safe}}</span>
                    </p>
                </div>
                {% endif %}
            {% endfor %}

            {% if view.custom_card_content_template %}
                <div>
                    {% include view.custom_card_content_template %}
                </div>
            {% endif %}

        </div>
    </div>

    {% if forloop.last and group.page_obj.has_next %}
        <div id ="pagination-container-{{instance.stage_id.id}}" >
            <div
                class="htmx-sentinel"
                hx-get="{{request.path}}?{{request.GET.urlencode}}&page_{{key}}={{ group.page_obj.next_page_number }}"
                hx-trigger="intersect once"
                hx-swap="outerHTML"
                hx-target="#pagination-container-{{instance.stage_id.id}}"
                hx-select="#kanbanCandidates{{key}}"
                hx-indicator=".htmx-indicator"
                id="load-more-{{instance.stage_id.id}}"
            >
                <div class="htmx-indicator" >
                    <div class="flex justify-center items-center p-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-[#e54f38]"></div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endfor %}
